<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="v1.0, 2022">
<title>Rai Multicast Services Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>Rai Multicast Services Guide</h1>
<div class="details">
<span id="author" class="author">v1.0, 2022</span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_description">Description</a></li>
<li><a href="#_architecture">Architecture</a></li>
<li><a href="#_why_use_it">Why use it?</a></li>
<li><a href="#_building">Building</a></li>
<li><a href="#_running_the_ms_server">Running the MS server</a></li>
</ul>
</li>
<li><a href="#config">Configuration</a>
<ul class="sectlevel2">
<li><a href="#_key_configuration">Key Configuration</a></li>
<li><a href="#_parameters">Parameters</a></li>
</ul>
</li>
<li><a href="#authentication">Authentication</a>
<ul class="sectlevel2">
<li><a href="#_key_exchange">Key Exchange</a></li>
<li><a href="#_system_compromise">System Compromise</a></li>
<li><a href="#_message_authentication">Message Authentication</a></li>
</ul>
</li>
<li><a href="#_subjects">Subjects</a>
<ul class="sectlevel2">
<li><a href="#_wildcarding_subscriptions">Wildcarding Subscriptions</a></li>
<li><a href="#_the_inbox_subject">The _INBOX subject</a></li>
<li><a href="#_rv_subject_rules">RV subject rules</a></li>
<li><a href="#_nats_subject_rules">NATS subject rules</a></li>
<li><a href="#_redis_subject_rules">Redis subject rules</a></li>
</ul>
</li>
<li><a href="#network">Networking</a>
<ul class="sectlevel2">
<li><a href="#_description_of_transports">Description of Transports</a></li>
<li><a href="#service_and_networks">Services and Networks</a></li>
<li><a href="#_cost">Cost</a></li>
<li><a href="#_tcp_encryption">TCP Encryption</a></li>
<li><a href="#_open_pgm">Open PGM</a></li>
<li><a href="#_tcp_mesh">TCP Mesh</a></li>
<li><a href="#_tcp_point_to_point">TCP Point-to-point</a></li>
<li><a href="#_tib_rv">Tib RV</a></li>
<li><a href="#_nats">NATS</a></li>
<li><a href="#_redis">Redis</a></li>
<li><a href="#_telnet">Telnet</a></li>
<li><a href="#_web">Web</a></li>
</ul>
</li>
<li><a href="#linkstate">Link State</a>
<ul class="sectlevel2">
<li><a href="#_the_forwarding_set">The Forwarding Set</a></li>
</ul>
</li>
<li><a href="#message_loss">Message Loss</a>
<ul class="sectlevel2">
<li><a href="#_multicast_sequence_numbers">Multicast sequence numbers</a></li>
<li><a href="#_subscription_sequence_window">Subscription sequence window</a></li>
<li><a href="#_configuration_for_sequence_windows">Configuration for sequence windows</a></li>
<li><a href="#_show_loss">Show loss</a></li>
<li><a href="#_notification_of_message_loss">Notification of message loss</a></li>
</ul>
</li>
<li><a href="#_internal_protocol">Internal Protocol</a>
<ul class="sectlevel2">
<li><a href="#_field_values">Field Values</a></li>
<li><a href="#_message_framing">Message Framing</a></li>
<li><a href="#_system_subjects">System Subjects</a></li>
<li><a href="#_heartbeat_subjects">Heartbeat Subjects</a></li>
<li><a href="#_link_state_subjects">Link State Subjects</a></li>
<li><a href="#_subscription_subjects">Subscription Subjects</a></li>
<li><a href="#_inbox_subjects">Inbox Subjects</a></li>
<li><a href="#example_message_flow">Example Message Flow</a></li>
</ul>
</li>
<li><a href="#rvd">rvd Compatibility</a>
<ul class="sectlevel2">
<li><a href="#_rvd_arguments">rvd Arguments</a></li>
<li><a href="#_service_key_configuration">Service Key Configuration</a></li>
<li><a href="#_starting_in_rvd_compatibility_mode">Starting in rvd Compatibility Mode</a></li>
<li><a href="#_connecting_to_networks">Connecting to Networks</a></li>
<li><a href="#_the_peer_names">The Peer Names</a></li>
</ul>
</li>
<li><a href="#console">Console</a></li>
<li><a href="#_monitoring">Monitoring</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_description">Description</h3>
<div class="paragraph">
<p>Rai MS is a Link State based protocol for the construction of Pub/Sub messaging
systems which allows for loops and redundancies in the network connections
between peers.  It has 4 different types of network transports:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>OpenPGM based multicast, with an unicast inbox protocol.</p>
</li>
<li>
<p>TCP point to point connections.</p>
</li>
<li>
<p>Mesh TCP all to all connections.</p>
</li>
<li>
<p>Local bridging compatible with RV, NATS, Redis.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The first 3 transports may be interconnected with redundancies.  The local
bridging transports strips or adds the meta-data of the message that allows for
routing through the network, so it can&#8217;t be looped.</p>
</div>
<div class="paragraph">
<p>It uses a best effort delivery system.  It serializes messages based on subject
so that streams are delivered in order discarding duplicates, but messages
which are lost in transit because of node or network failures, are not
retransmitted.</p>
</div>
</div>
<div class="sect2">
<h3 id="_architecture">Architecture</h3>
<div class="sect3">
<h4 id="_authentication">Authentication</h4>
<div class="paragraph">
<p>A ECDSA key pair is generated for a service and for each user that is
pre-configured.  A ECDH key is generated for by peer on startup for a key
exchange that establishes a 32 byte session key.  This session key is used to
authenticate messages sent and received.  Each peer in the system has a unique
session key so that a message from any one of them can be authenticated.
This is described further in <a href="#authentication">Authentication</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_console_interface">Console Interface</h4>
<div class="paragraph">
<p>The model that a node implements in the base client is close to that of a
router.  The command line resembles a cisco style interface with the ability to
bring up and down transports at run time, examine the state of them, ping other
nodes, traceroute, get help on commands with the <em>?</em> key, use command line
completion, telnet into the node.  More in <a href="#console">Console</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_networking">Networking</h4>
<div class="paragraph">
<p>A node consists of a router with several transports.  The term "transport" is
modeled as a switch, where other nodes on the transport are attached to switch
and one port of the switch is attached to the router.  All of the nodes plugged
into the switch can communicate without going through the router.  The
facilitates a multicast style transport, where a single multicast send reaches
multiple nodes within the switch.  It also allows an listener to accept
multiple local connections which use a protocol like RV, NATS, or Redis and do
communication without regard to the other nodes attached to other switches or
transports through the router.</p>
</div>
<div class="paragraph">
<p>The subscription mechanism has three layers:  the router, the switch, and the
connection.  The router uses bloom filters to route subjects, the switch uses
32 bit mac addresses based on the subject/wildcard hash, and the connection
uses a btree of subjects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  router &lt;-&gt; bloom filter 1 &lt;-&gt; switch 1 &lt;-&gt; mac 1 &lt;-&gt; connection 1 &lt;-&gt; btree entry 1
             bloom filter 2     switch 2     mac 2     connection 2     btree entry 2</pre>
</div>
</div>
<div class="paragraph">
<p>More about this in the <a href="#network">Networking</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="_link_state_database">Link-State Database</h4>
<div class="paragraph">
<p>The first thing a node does after authentication, is download the peers LSDB
(Link-State DB), which first consists of records for every other peer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  { bridge id, session key, peer name, sub seqno, link seqno, bloom }</pre>
</div>
</div>
<div class="paragraph">
<p>The seqno values allow for delta updates of the LSDB, which can add/remove a
link or add/remove a subscription from the bloom filter.  The bloom filter
contains everything needed to filter the subscriptions that the peer has
interest.  It generally uses about 2 bytes per subscription for a false
positive error rate at about 0.05% (1 in 2000 subjects), so if a peer has a
10,000 subjects or wildcards open, it will be about 20,000 bytes in size.</p>
</div>
<div class="paragraph">
<p>Then for each bridge id, it downloads the links that the peer is connected
to for each transport/switch.  The local bridging that occurs for foreign
protocols like RV, NATS and Redis are directly attached to the peer and are
considered the peers subscriptions.  In other words, the bloom filter for a
peer has all of the subscriptions for every RV, NATS or Redis client
connected to it.</p>
</div>
<div class="paragraph">
<p>The link records are for nodes which are directly attached to the peer via
a transport.  There may be many nodes using the same link attached to the
peer and a node may be reachable via multiple transports.  The unique
feature identifying this link is the bridge id, tport id pair.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  { bridge id, tport name, peer name, tport id, cost }</pre>
</div>
</div>
<div class="paragraph">
<p>A delta update of the LSDB, whether link change or subscription change is
broadcast to all of the nodes.  If an network split occurs and some nodes are
orphaned from the network for a period before rejoining, then synchronization
of the LSDB with a peer occurs when the sub seqno or the link seqno has
advanced.  Any peer is capable of updating any other peer since the LSDB is the
same in every one.  The primary means of watching the seqno changes is with a
transport heartbeat sent on a 10 second (default) interval between directly
connected peers.  In addition, each peer randomly chooses another peer to ping
at a random interval based on the heartbeat interval.</p>
</div>
<div class="paragraph">
<p>The behavior of a transport which becomes too congested is that the heartbeat
misses and the link is dropped and rejoined at the next heartbeat.  The effect
of this is that 10 seconds of traffic is rerouted or lost if there are no other
routes to the peers on the other side.</p>
</div>
<div class="paragraph">
<p>More in the <a href="#linkstate">Link State</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="_multicast_routing">Multicast routing</h4>
<div class="paragraph">
<p>Any time a link is added to the LSDB, the routing is recalculated using a
Dijkstra path finding algorithm.  The shortest path is chosen, and if multiple
equal paths exist, then the link with the lowest weight is chosen.  Load
balancing can occur when there are two or more equal paths to a peer based on
the subject mac of the destination.  The LSDB is considered "consistent" when
all peers agree that a link exists.  If peer A has an outgoing link to peer B,
then peer B must have a link to peer A.  If this is not the case, then LSDB
synchronization requests to the closest peer along the path are performed until
the network converges to a consistent state.</p>
</div>
<div class="paragraph">
<p>All peers will choose the same route for a subject when the LSDB is
synchronized.  If the LSDB is not synchronized, then messages may be duplicated
to alternative routes or may decide that routing is not necessary for a message
when it is.  For this reason, keeping the LSDB synchronized as fast as possible
is a top priority of a node.</p>
</div>
<div class="paragraph">
<p>A technique called reverse path forwarding is used for multicast messages.  If
a destination unicast to a peer, which is the case for inbox style messaging,
then there is only one path for the message, the shortest path.  With
multicast, there are multiple paths that a message may take, each is the
shortest path to a subscriber.  Reverse path forwarding uses the source of the
message to route it.  The algorithm increments the distance from the source to
compute a set of nodes that are possible for a message at each hop, then
chooses the best traversal of the network graph so that the entire network is
covered with a minimal set of transmissions.  Once this is calculated, it can
be reused until a link in the LSDB is updated again.  This set of paths is
augmented with bloom filters from the peers, so that a router will forward a
message only if it passes through the reverse path forwarding algorithm and it
passes through the bloom filters attached to the path.</p>
</div>
</div>
<div class="sect3">
<h4 id="_wildcard_matching">Wildcard Matching</h4>
<div class="paragraph">
<p>A generic PCRE based conversion is used to enable multiple wildcard styles to
coexist between peers.  The bloom filter contains both a prefix and suffix
matching filter, so that A.*.B is matched with both ends of the wildcard.  When
a subject is passed through a bloom filter the prefix of the subject is hashed
with different seeds based on the prefix lengths used.  If a peer is interested
in subject prefix lengths of 3, 5, 10, 20, as well as the subject itself, these
lengths are noted in the bloom filter and the hash set is calculated as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  hs = hash( subject, seed = 0 )
  h3 = hash( subject[1..3], seed = 3 )
  h5 = hash( subject[1..5], seed = 5 )
  h10 = hash( subject[1..10], seed = 10 )
  h20 = hash( subject[1..20], seed = 20 )</pre>
</div>
</div>
<div class="paragraph">
<p>If any of these are hash values present in the bloom filter, then a check for
the suffix matches are done.  The hash set is computed in groups before any
routing based on the entire set of hashes needed is done in order to take
advantage of instruction parallelism, computing several hashes for each
iteration of the subject length.</p>
</div>
</div>
<div class="sect3">
<h4 id="_anycast_and_shardcast">Anycast and Shardcast</h4>
<div class="paragraph">
<p>An anycast route is a single match of many.  A set of peers interested in a
subject can be computed because the LSDB contains filters for all of them.
This set of peers interested can be randomly chosen and unicast routed to the
chosen peer.  If the peer has a false match, or the interest in the subject is
lost, then that peer can choose another from the set and forward it.</p>
</div>
<div class="paragraph">
<p>A shardcast is a set of peers interested in the prefix of a subject, but only a
shard of the subject space.  The bloom filter contains enough info to filter by
both the prefix hash and the subject space that a peer is interested in.  In
this case, the peers have predetermined how many shards there should be and how
the shards are split between them.  If A subscribes to X.* using shard 1/2 and
B subscribes to X.* using shard 2/2, then the subjects X.Y and X.Z is split
between A and B based on the hash of X.Y and the hash of X.Z.  This is a
variation of suffix matching where the hash of the subject is used to
discriminate the route of the message.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_why_use_it">Why use it?</h3>
<div class="paragraph">
<p>Distributed systems are more often crossing network boundaries.  Traditional
broker based systems or multicast based systems have difficulty expanding
beyond a these boundaries.  To remedy this, network designs may deploy
application specific routers, or they shard the messaging system, or they use
other protocols like mesh or gossip based systems.  All of these solutions have
advantages and drawbacks.</p>
</div>
<div class="paragraph">
<p>The aim of this system is to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Flexible transports and networking.</p>
</li>
<li>
<p>Fast message authentication.</p>
</li>
<li>
<p>Fast network convergence.</p>
</li>
<li>
<p>Distribute messages only when interest is present.</p>
</li>
<li>
<p>Utilize redundant links.</p>
</li>
<li>
<p>Flexible message distribution:  inbox, multicast, anycast, shardcast.</p>
</li>
<li>
<p>Flexible wildcarding mechanism.</p>
</li>
<li>
<p>Ability to recover subscription interest at the endpoints.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_building">Building</h3>
<div class="paragraph">
<p>There are a lot of submodules and dependencies, so at present, building using
the <a href="https://github.com/raitechnology/build">build</a> Makefile is the easiest way
to compile everything.  Clone it, install the dependencies, clone all of the
modules, build everything.  The rpm dependencies will probably need the
<a href="https://docs.fedoraproject.org/en-US/epel/">EPEL repo</a> installed when using an
enterprise RedHat, CentOS, or derivative for the liblzf-devel package (and
maybe others).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  $ git clone https://github.com/raitechnology/build
  $ cd build
  $ make install_rpm_deps
  $ make clone
  $ make</pre>
</div>
</div>
<div class="paragraph">
<p>If this completes, there will be a static binary at <code>raims/OS/bin/ms_server</code>
where OS is something like <code>RH8_x86_64</code>.</p>
</div>
<div class="paragraph">
<p>If you set the env var for debugging, then the <code>RH8_x86_64-g</code> directory will be
populated without optimization and with the -g flag.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  $ export port_extra=-g
  $ make</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_ms_server">Running the MS server</h3>
<div class="paragraph">
<p>The first task is to create the authentication keys for a service "test".  The
<code>ms_gen_key</code> program creates and updates the configuration.  The user keys are
what stored in the <code>user_X_svc_test.yaml</code> files and contain ECDH key pairs.
The service is a ECDSA key pair and signs each user and stores the signatures
in the <code>svc_test.yaml</code> file.  The <code>startup.yaml</code> contains the startup config.
The <code>config.yaml</code> file includes all of the files in the config directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  $ cd build/raims
  $ ms_gen_key -u A B C -s test
  create dir  config                          -- the configure directory
  create file config/.salt                    -- generate new salt
  create file config/.pass                    -- generated a new password
  create file config/config.yaml              -- base include file
  create file config/param.yaml               -- parameters file
  create file config/svc_test.yaml            -- defines the service and signs u
  create file config/user_A_svc_test.yaml     -- defines the user
  create file config/user_B_svc_test.yaml     -- defines the user
  create file config/user_C_svc_test.yaml     -- defines the user
  OK? y
  done</pre>
</div>
</div>
<div class="paragraph">
<p>This creates the keys for users A, B, and C.  These keys are encrypted with the
<code>.pass</code> and <code>.salt</code> files.</p>
</div>
<div class="paragraph">
<p>More about this in the [key config guide](keys.md).</p>
</div>
<div class="paragraph">
<p>Run the <code>ms_server</code> program and configure it.  The <code>-u</code> option specifies the
user and service.  The <code>-c</code> option starts the command line interface, where the
networks can be defined and connected.  This following defines a mesh endpoint
and saves it to the startup config.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  $ ms_server -u B.test -c
  05:54:26.267  session A.test[RthXjJscfuvnG2+J1/PJ1w] started, start time 1644818066.265990830
  A.test[RthXjJscfuvnG2+J1/PJ1w]@tracy[249]&gt; configure transport mytran
  A.test[RthXjJscfuvnG2+J1/PJ1w]@tracy[250](mytran)&gt; type mesh
  A.test[RthXjJscfuvnG2+J1/PJ1w]@tracy[251](mytran)&gt; listen *
  A.test[RthXjJscfuvnG2+J1/PJ1w]@tracy[252](mytran)&gt; port 5000
  A.test[RthXjJscfuvnG2+J1/PJ1w]@tracy[253](mytran)&gt; show
  tport: mytran
  type: mesh
  route:
    listen: "*"
    port: 5000
  A.test[RthXjJscfuvnG2+J1/PJ1w]@tracy[254](mytran)&gt; exit
  A.test[RthXjJscfuvnG2+J1/PJ1w]@tracy[255]&gt; listen mytran
  transport "mytran" started listening
  05:55:09.934  listening on [::]:5000
  05:55:09.937  network converges 0.003 secs, 0 uids authenticated, add_tport
  A.test[RthXjJscfuvnG2+J1/PJ1w]@tracy[256]&gt; save
  config saved
  05:55:12.790  update file A/param.yaml            -- parameter config
  05:55:12.790  create file A/startup.yaml          -- startup config
  05:55:12.790  create file A/tport_mytran.yaml     -- transport</pre>
</div>
</div>
<div class="paragraph">
<p>The files are described in the <a href="#configuration">[configuration]</a> section and the
transports are described in the <a href="#network">Networking</a> section.  The
authentication keys need to be distributed to all the nodes, but the networking
config will be somewhat unique to each node.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="config">Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_key_configuration">Key Configuration</h3>
<div class="paragraph">
<p>The key configuration files are necessary to join the network.  They
authenticate peers and the message traffic that flows between peers.  It does
not authenticate the local bridging protocols RV, NATS, or Redis.</p>
</div>
<div class="paragraph">
<p>Generating a master config is done with the <code>ms_gen_key</code> program.  The default
location for the config directory is <code>./config</code>, other locations are specified
with the <code>-d</code> option.</p>
</div>
<div class="paragraph">
<p>Initially, the config directory is empty.  Initialize with some users and a
service name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  $ ms_gen_key -u A B C -s test
  create dir  config                          -- the configure directory
  create file config/.salt                    -- generate new salt
  create file config/.pass                    -- generated a new password
  create file config/config.yaml              -- base include file
  create file config/param.yaml               -- parameters file
  create file config/svc_test.yaml            -- defines the service and signs users
  create file config/user_A_svc_test.yaml     -- defines the user
  create file config/user_B_svc_test.yaml     -- defines the user
  create file config/user_C_svc_test.yaml     -- defines the user
  OK? y
  done</pre>
</div>
</div>
<div class="paragraph">
<p>Exporting the keys for each of the nodes causes the <code>.pass</code> file the change and
the unnecessary private keys to be removed.  The only private key that remains,
is for the peer.  This trimmed configuration allows the peer to run, but not
generate new peers because the private key of the service is not present.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  $ ms_gen_key -x A B C -s test
  - Loading service "test"
  - Signatures ok
  create dir  A                          -- exported configure directory
  create file A/.salt                    -- a copy of salt
  create file A/.pass                    -- generated a new password
  create file A/param.yaml               -- a copy of param
  create file A/config.yaml              -- base include file
  create file A/svc_test.yaml            -- defines the service and signs users
  create file A/user_A_svc_test.yaml     -- defines the user
  create file A/user_B_svc_test.yaml     -- defines the user
  create file A/user_C_svc_test.yaml     -- defines the user
  create dir  B                          -- exported configure directory
  create file B/.salt                    -- a copy of salt
  create file B/.pass                    -- generated a new password
  create file B/param.yaml               -- a copy of param
  create file B/config.yaml              -- base include file
  create file B/svc_test.yaml            -- defines the service and signs users
  create file B/user_A_svc_test.yaml     -- defines the user
  create file B/user_B_svc_test.yaml     -- defines the user
  create file B/user_C_svc_test.yaml     -- defines the user
  create dir  C                          -- exported configure directory
  create file C/.salt                    -- a copy of salt
  create file C/.pass                    -- generated a new password
  create file C/param.yaml               -- a copy of param
  create file C/config.yaml              -- base include file
  create file C/svc_test.yaml            -- defines the service and signs users
  create file C/user_A_svc_test.yaml     -- defines the user
  create file C/user_B_svc_test.yaml     -- defines the user
  create file C/user_C_svc_test.yaml     -- defines the user
  OK? y
  done</pre>
</div>
</div>
<div class="paragraph">
<p>Copy the A config to the A node/config, the B config directory to the B
node/config, etc.  The <code>.pass</code> file is unique for each peer so that it can be
removed after running the server, rendering the configured keys unreadable
until the <code>.pass</code> file is restored or the peer&#8217;s config is regenerated from the
master config.</p>
</div>
<div class="paragraph">
<p>The copy of the master config includes a copy of the <code>param.yaml</code>, as that can
contain global configuration, but doesn&#8217;t copy any local configuration such as
startup and network configuration.</p>
</div>
<div class="paragraph">
<p>The master config will also work, so just copying it to the peers will allow
them to run if this type of security is unnecessary.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parameters">Parameters</h3>
<div class="paragraph">
<p>The parameters section of the configuration is used to lookup values that can
alter the behavior of the server.  These fields can be set anywhere in the
config files, but are usually in the "param.yaml" or "startup.yaml" files.
Since the "config.yaml" includes "*.yaml", any yaml file in the config
directory can contain parameters.  Any field value pair which is not in a
service, user, service, transport, or group section is added to the parameters
section.</p>
</div>
<div class="paragraph">
<p>This configuration is a list of parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>parameters:
  pass: .pass
  salt: .salt
heartbeat: 5 secs
reliability: 10 secs
tcp_noencrypt: true
listen:
  - mymesh
  - myweb
connect:
  - mytcp</pre>
</div>
</div>
<div class="paragraph">
<p>The "parameters:" structure is optional and not necessary to define them.</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">salt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">filename</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File to find encryption salt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">filename</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File to find encryption password</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">salt_data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base 64 encoded encryption salt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pass_data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base 64 encoded encryption password</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Startup listen transports</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Startup connect transports</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pub_window_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 MB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of publish window</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sub_window_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 MB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of subscribe window</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pub_window_time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 secs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time of publish window</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sub_window_time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 secs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time of subscribe window</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">heartbeat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 secs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval of heartbeat</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">reliability</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15 secs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time of publish reliability</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOCAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log using local time or GMT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pid_file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Daemon pid file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">map_file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use for key value storage</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">db_num</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default db number for key value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ipc_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connect to IPC sockets</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tcp_timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 secs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default timeout for TCP/mesh connect</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tcp_ipv4only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use IPv4 addressing only</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tcp_ipv6only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use IPv6 addressing only</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tcp_noencrypt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default for TCP/mesh encryption</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tcp_write_timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 secs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout for TCP write</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tcp_write_highwater</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 MB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP write buffer size</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>salt, pass, salt_data, pass_data&#8201;&#8212;&#8201;The salt, pass or salt_data, pass_data
are required for startup.  The keys defined in the configuration are
encrypted with these values.  Any key derived during execution is mixed with
the salt and must be the same in all peers.</p>
</li>
<li>
<p>listen, connect&#8201;&#8212;&#8201;The startup transports.  They are started before any other
events are processed.  If a listen fails, then the program exits.  A connect
failure will not cause an exit, since it retries.</p>
</li>
<li>
<p>pub_window_size, sub_window_size, pub_window_time, sub_window_time&#8201;&#8212;&#8201;These
track the sequence numbers of messages sent and received.  They are described
in <a href="#pub_window">[pub_window]</a>.</p>
</li>
<li>
<p>heartbeat&#8201;&#8212;&#8201;The interval which heartbeats are published to directly
connected peers.  A link is not active when a heartbeat is missed for
1.5 times this interval.  The link is reactivated when a heartbeat is
received.</p>
</li>
<li>
<p>timestamp&#8201;&#8212;&#8201;When set to GMT, the time stamps are not offset by the local
timezone.</p>
</li>
<li>
<p>pid_file&#8201;&#8212;&#8201;A file that contains the process id when forked in rvd mode.</p>
</li>
<li>
<p>map_file&#8201;&#8212;&#8201;If a Redis transport is used, this is where the data is stored.
If no map is defined, then the data stored will fail and data retrieved will
be zero.  The <code>kv_server</code> command will initialize a map file.</p>
</li>
<li>
<p>db_num&#8201;&#8212;&#8201;The default database number for the Redis transport.</p>
</li>
<li>
<p>ipc_name&#8201;&#8212;&#8201;When set, allows IPC processes to connect through Unix sockets
and subscription maps using the same name.  If the processes are shutdown,
they will restart or stop the subscriptions using the maps.</p>
</li>
<li>
<p>tcp_timeout&#8201;&#8212;&#8201;The default retry timeout for TCP and mesh connections.</p>
</li>
<li>
<p>tcp_ip4only&#8201;&#8212;&#8201;Resolve DNS hostnames to IPv4 addresses only.</p>
</li>
<li>
<p>tcp_ip6only&#8201;&#8212;&#8201;Resolve DNS hostnames to IPv6 addresses only.</p>
</li>
<li>
<p>tcp_noencrypt&#8201;&#8212;&#8201;When true, the default for TCP and mesh connections is to
to not encrypt the traffic.</p>
</li>
<li>
<p>tcp_write_timeout&#8201;&#8212;&#8201;Amount of time to wait for TCP write progress if the
write buffer is full.  After this time, socket is disconnected and messages
lost.  When a TCP write buffer has equal or more than <code>tcp_write_highwater</code>
bytes then backpressure can be applied to the sockets that are forwarding
data, causing them to add latency waiting for the writer to have space
available.</p>
</li>
<li>
<p>tcp_write_highwater&#8201;&#8212;&#8201;Amount of data to buffer for writing before applying
back pressure to forwarding sockets.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentication">Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Authentication has two parts, the initial key exchange that sets up unique
session key for each pear and message authentication that verifies that a peer
sent it.  The key exchange protocol uses a Elliptic Curve Diffie Hellman (ECDH)
exchange that is signed by a Elliptic Curve Digital Signature (ECDSA).  The
message authentication uses a HMAC digest computed by enveloping the message
with a peer&#8217;s session key and computing the hash along with sequencing by
subject to prevent a replay of messages.</p>
</div>
<div class="sect2">
<h3 id="_key_exchange">Key Exchange</h3>
<div class="paragraph">
<p>Two peers authenticate with each other by signing a message with a configured
ECDSA key.  This message includes a generated a ECDH public key.  The ECDH key
is used by each side to compute the secret using the corresponding ECDH private
key.  The secret along with a unique nonce, a time stamp, and a sequence number
to create a temporary key that is used to encrypt a random session key.</p>
</div>
<div class="paragraph">
<p>For peers A and B to complete the key exchange, there are 4 messages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HELLO/HB from peer A sent to peer B&#8201;&#8212;&#8201;Includes a seqno, a time, a nonce, and
a ECDH public key.  Since these are unique for each side, call these A_seqno,
A_time, A_nonce, A_ECDH_pub</p>
</li>
<li>
<p>AUTH from peer B sent to peer A&#8201;&#8212;&#8201;Includes B_ECDSA_sig, B_seqno, B_time,
B_nonce, B_ECDH_pub, B_auth_key, A_seqno, and A_time.  The A_seqno and A_time
allow peer A to match the unique A_nonce which corresponds to the HELLO
message sent previously.  The last two HELLO messages are tracked so it must
match one of these.  The B_auth_key contains an AES encrypted session key
which must be decrypted by computing a temporary key using the data from B as
well as the ECDH secret computed from B_ECDH_pub and A_ECDH_pri.  Peer A
trusts peer B if the decrypted session key in B_auth_key authenticates the
message using the HMAC computation and the HMAC computation is also signed
by B_ECDSA_sig.</p>
</li>
<li>
<p>AUTH from peer A sent to peer B&#8201;&#8212;&#8201;The reverse of above, includes
A_ECDSA_sig, A_seqno, A_time, A_nonce, A_ECDH_pub, A_auth_key, B_seqno, and
B_time.  The B_seqno and B_time are used to match the B_nonce included in the
previous AUTH and used by peer A to create the temporary key which encrypts
the A_auth_key session key for A.  B trusts peer A if the decrypted session
key in A_auth_key authenticates the message using the HMAC computation and
the HMAC computation is also signed by A_ECDSA_sig.</p>
</li>
<li>
<p>AUTH_OK from peer B sent to peer A&#8201;&#8212;&#8201;This notifies peer B that
authentication was successful.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If either AUTH fails the HMAC computation, then the authentication fails and
one or both peers are ignored for a 20 seconds (or 2 times the heartbeat
interval).  It is possible that the latency of the key exchange is greater than
2 HELLO/HB messages so the nonce associated with the seqno/time pair is too old
and the authentication must restart.</p>
</div>
<div class="paragraph">
<p>The ECDSA private key used to sign the authentication messages is either the
configured key pair from the service or the configured key pair from the user.
A configuration may not include the service private key in the case that a user
has less privileges that the service, which has admin privileges.  The
service&#8217;s private key is able to sign users which don&#8217;t exist and are added to
the system, but a user&#8217;s private key can only authenticate itself.</p>
</div>
<div class="paragraph">
<p>The ECDH algorithm used is
<a href="https://github.com/floodyberry/curve25519-donna">EC25519</a>.  The ECDSA algorithm
used is <a href="https://github.com/floodyberry/ed25519-donna">ED25519</a>.</p>
</div>
<div class="paragraph">
<p>The following is from the <a href="#example_message_flow">Example Message Flow</a>.  This shows the HELLO/HB
part of the key exchange, where peer A is ruby and peer B is dyna.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>_X.HELLO ... ruby -&gt; dyna
   bridge_16 [1027]   : xq6vl+2HcoDxtt+7lC7dGQ
   digest_16 [1029]   : mB1uDQ7fsGmYScIGU0kt6Q
   sub_s2 [1792]      : "_X.HB"
   user_hmac_16 [1028] : TQO1sorP9oD+smMOrnvzuQ
   seqno_2 [273]      : 1
   time_8 [787]       : 1663967268385616894
   uptime_8 [788]     : 17982050574
   start_8 [794]      : 1663967250404676993
   interval_2 [277]   : 10
   cnonce_16 [1034]   : IG45ISINnT0bX2Td6Ovivw
   pubkey_32 [1357]   : +A2dlZCcDo8vS/XsWApNNfJwQH8ApmFIRTOcS+cPuAk
   sub_seqno_2 [274]  : 0
   user_s2 [1836]     : "ruby"
   create_s2 [1838]   : "1663967250.404513467"
   link_state_2 [281] : 0
   converge_8 [839]   : 1663967250404676993
   uid_cnt_2 [292]    : 0
   uid_csum_16 [1036] : xq6vl+2HcoDxtt+7lC7dGQ
   version_s2 [1840]  : "1.12.0-42"
   pk_digest_16 [1091] : SMnBqzoh/w6IFi2c7zoxMw</pre>
</div>
</div>
<div class="paragraph">
<p>The seqno_2, time_8, cnonce_16, pubkey_32 are the A_seqno, A_time, A_nonce, and
A_ECDH_pub.  The user_hmac_16, start_8, and service ECDSA_pub are combined to
create a hello_key which is used to authenticate the HELLO message stored in
pk_digest_16, since the session key that is product of the key exchange is not
yet known by dyna.  The service ECDSA_pub is never sent over the wire so it is
used as a pre-shared key in this instance.  There is another pre-shared key
used by the Key Derivation Function (KDF) to generate keys from secrets,
nonces, seqnos, and time stamps.  The KDF is seeded by a 640 byte salt and
shared along with the service ECDSA_pub key in all of the peers that need to
communicate.</p>
</div>
<div class="paragraph">
<p>The first AUTH message from peer B (dyna) to peer A (ruby):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>_I.xq6vl+2HcoDxtt+7lC7dGQ.auth ... dyna -&gt; ruby
   bridge_16 [1027]   : wwEnbQEY2FMuwZGSjpi3jQ
   digest_16 [1029]   : 3UY+SJQYy3wGN0dW3zc4fg
   sub_s2 [1792]      : "_I.xq6vl+2HcoDxtt+7lC7dGQ.auth"
   user_hmac_16 [1028] : PYv43FUBG3N8ok+jn4nBPQ
   seqno_2 [273]      : 1
   time_8 [787]       : 1663967268386849657
   uptime_8 [788]     : 63309580030
   interval_2 [277]   : 10
   sub_seqno_2 [274]  : 0
   link_state_2 [281] : 0
   auth_seqno_2 [285] : 1
   auth_time_8 [798]  : 1663967268385616894
   auth_key_64 [1542] : AdM61M2DqR6hXdVnPnp716n5lQwcBAyx0N1jzGtzIM9OmAF4txsoZRd1YMOySIcxkyydHELJHfgVflEtnLg9Fg
   cnonce_16 [1034]   : TEbM+MfLCp66ds36xh0JAA
   pubkey_32 [1357]   : PyEHl7Y3IxAkK5OQMnJzggmlKlUo8+RiBif0P7h+8kg
   auth_stage_2 [305] : 1
   user_s2 [1836]     : "dyna"
   create_s2 [1838]   : "1663967205.077153809"
   expires_s2 [1839]  : null
   start_8 [794]      : 1663967205077372910
   version_s2 [1840]  : "1.12.0-42"
   pk_sig_64 [1610]   : gR2ovdrI4yfxdc7ZAR+ID00hj2HDYEcEexU/ib4CDAU4t2E/nzC6c1dK0s14RiZIWzHHxRFR6D2uJ/ZaHHwaDw</pre>
</div>
</div>
<div class="paragraph">
<p>The auth_seqno_8, auth_time_8 are the A_seqno, A_time values from ruby used to
find the A_nonce (cnonce_16) in the HELLO message.  These along with seqno_8,
time_8, cnonce_16, and pubkey_32 are used to construct the temporary key
to decrypt the auth_key_64, which is session key used by dyna in the HMAC
computation that authenticates messages and compare the result to digest_16.
The pk_sig_64 is the ECDSA signature of the message signed either by the
service&#8217;s private key or by the user dyna&#8217;s private key.</p>
</div>
<div class="paragraph">
<p>After this succeeds, then ruby trusts messages from dyna that have a HMAC
computation digest_16 included with each message, along with an seqno and
time stamp to prevent replays.</p>
</div>
<div class="paragraph">
<p>The second AUTH message from peer A (ruby) to peer B (dyna):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>_I.wwEnbQEY2FMuwZGSjpi3jQ.auth ... ruby -&gt; dyna
   bridge_16 [1027]   : xq6vl+2HcoDxtt+7lC7dGQ
   digest_16 [1029]   : h81umkyeNoYJAbomEWE+ng
   sub_s2 [1792]      : "_I.wwEnbQEY2FMuwZGSjpi3jQ.auth"
   user_hmac_16 [1028] : TQO1sorP9oD+smMOrnvzuQ
   seqno_2 [273]      : 1
   time_8 [787]       : 1663967268387280755
   uptime_8 [788]     : 17982688972
   interval_2 [277]   : 10
   sub_seqno_2 [274]  : 0
   link_state_2 [281] : 0
   auth_seqno_2 [285] : 1
   auth_time_8 [798]  : 1663967268386849657
   auth_key_64 [1542] : v4mYze2OruL2L02gODDt7Fd9FHTDPLO0UD/auhab+FJiGgbD473osbwlYKfYBVgwvZMFqbLpVnLiGPHD+MXPtw
   cnonce_16 [1034]   : zUYBUCh9n0L4F0dltxxtyg
   pubkey_32 [1357]   : +A2dlZCcDo8vS/XsWApNNfJwQH8ApmFIRTOcS+cPuAk
   auth_stage_2 [305] : 2
   user_s2 [1836]     : "ruby"
   create_s2 [1838]   : "1663967250.404513467"
   expires_s2 [1839]  : null
   start_8 [794]      : 1663967250404676993
   version_s2 [1840]  : "1.12.0-42"
   pk_sig_64 [1610]   : 6lU9Yz3cvW178goVHwakHsFR55TYid9SHDwjIl/fPrxFVCkCujLxK2HQXNtw3zeVRgmi01pGEqemBUW59YuNDA</pre>
</div>
</div>
<div class="paragraph">
<p>The same exchange from the first AUTH message is used in order for dyna to
trust ruby.</p>
</div>
</div>
<div class="sect2">
<h3 id="_system_compromise">System Compromise</h3>
<div class="paragraph">
<p>If a host is compromised and the KDF pre-shared key and service ECDSA_pub key
are discovered along with a user ECDSA_pri key, then an unauthorized party
could masquerade as that user.  One way to prevent this is to remove the
pre-shared 640 salt file after starting a server and a unique password file
used to encrypt the ECDSA keys in the configuration files.  The attacker would
need to extract these from the process space of the server and design a system
that uses this data.</p>
</div>
<div class="paragraph">
<p>The user ECDSA_pri key is needed to authenticate new peers, so it remains in
memory for the duration of the process.  A design that drops the private key
material after this key exchange could prevent this type of attack.</p>
</div>
</div>
<div class="sect2">
<h3 id="_message_authentication">Message Authentication</h3>
<div class="paragraph">
<p>The function of the key exchange protocol is to initialize each peer with a
random 32 byte session key.  The function of this key is to authenticate
messages.  A HMAC calculation of the message is done by enveloping the message
data with the key and hashing it using a AES based hash that results in a 8
byte digest:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  AES( IV = 8 bytes key )( [ message ] [ 24 bytes key ] )</pre>
</div>
</div>
<div class="paragraph">
<p>Note that HMAC is traditionally performed as MD5( key.opad + MD5( key.ipad<br>
message ) ) or SHA3( message + key ).  The above AES construction is chosen
purely for speed, since AES instructions are widely available and an order of
magnitude faster than the other hashes.  This may change in the near future
with the addition SHA instructions.</p>
</div>
<div class="paragraph">
<p>The header of every message contains these 5 fields which identify the source
of the message, the HMAC digest of the message, the subject, a seqno and a
time stamp:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   bridge_16 [1027]   : h783olFEb9ve8K07E7PoQg
   digest_16 [1029]   : FKZxGPHiC7e5GXVKh2PWLg
   sub_s2 [1792]      : "_I.xq6vl+2HcoDxtt+7lC7dGQ.ping"
   seqno_2 [273]      : 4
   stamp_8 [838]      : 1663967313973571299</pre>
</div>
</div>
<div class="paragraph">
<p>This header ensures that a message never contains the same bits and is always
unique.  It also allows the receivers to check that a replay has not occurred
by tracking the sequences and time stamps for the subjects that it has seen
previously.  If the subject has never been seen before, then the time stamp is
used to check that the message is at least as old as the last network
convergence time stamp, described in more thoroughly in <a href="#message_loss">Message Loss</a>.  The
bridge_16 identifies the source of the message and the digest_16 is computed
with the source&#8217;s session key.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_subjects">Subjects</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_wildcarding_subscriptions">Wildcarding Subscriptions</h3>
<div class="paragraph">
<p>The subject schema used by the external bridged transports may introduce some
incompatibilities when routing from one to another.  The subscriptions and the
patterns are separate operators internally.  A subscription using wildcarding
characters is allowed, but not interpreted differently that any other subject.
A pattern subscription includes a field which causes the pattern to be
evaluated with different syntax rules, Redis GLOB or NATS/RV.  A publish is not
interpreted as a wildcard, even when it contains wildcard syntax.  Any string
of bytes can be subscribed or published, but the wildcarding follows the syntax
of the pattern type and uses a different subscription operator internally, as
Redis does (sub, unsub, psub, punsub).</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_inbox_subject">The _INBOX subject</h3>
<div class="paragraph">
<p>There is a special rule for subjects that begin with the prefix <code>_INBOX.</code>, it
is interpreted as a point to point message.  This subject format finds the
peers which are subscribers, typically just one, and sends the message point to
point for each one.  The subject and message are put into an envelope addressed
for each peer.  The peers that forward this message along the path to the
recipient recognize this as using a different forwarding rule than normal
multicast subjects.  For example, the point to point rules for forwarding will
use a UDP inbox protocol when OpenPGM is deployed.  The point to point rule
will still forward to all subscriptions of an inbox subject, but it is
optimized for the case that there is only one subscription.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rv_subject_rules">RV subject rules</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A subject segment is separated by <code>.</code> and cannot start with a period or end
with a period or have two periods appear within a subject without
characters in between.</p>
</li>
<li>
<p>A wildcard can substitute the segments with a <code>*</code> character or a trailing
<code>&gt;</code>.</p>
</li>
<li>
<p>A publish to a wildcard causes it to match the subjects subscribed.  This
is not supported by Rai MS since the bloom filters are not indexed by
segments.  Instead, Rai MS will route the wildcard publish as a normal
subject.</p>
</li>
<li>
<p>An <code>_INBOX.</code> prefix implies a point to point publish which translates to an
anycast Rai MS publish.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_nats_subject_rules">NATS subject rules</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Same subject segmentation as RV.</p>
</li>
<li>
<p>Same wildcarding as RV.</p>
</li>
<li>
<p>It is not possible to publish to a wildcard.</p>
</li>
<li>
<p>No inbox point to point messaging.</p>
</li>
<li>
<p>A queue group publish translates to a Rai MS anycast publish.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_redis_subject_rules">Redis subject rules</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>There are no limitations for the characters used in a subject.</p>
</li>
<li>
<p>A wildcard is subscribed using a <code>psub</code> operator, so the characters
are interpreted using wildcard rules.  A <code>*</code> character matches zero
or more, a <code>?</code> matches 0 or 1 characters.  A <code>[</code> and <code>]</code> match any
of the characters enclosed.  A <code>\</code> character escapes the wildcard
characters.  It is similar to a shell glob wildcard.</p>
</li>
<li>
<p>A publish to a wildcard is the same as publishing to a subject.</p>
</li>
<li>
<p>No inbox point to point messaging and does not have syntax for
request/reply semantics.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="network">Networking</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_description_of_transports">Description of Transports</h3>
<div class="paragraph">
<p>A Rai MS transports function is to join all of the peers connected through a
node together in one virtual overlay network that provides basic pub/sub
multicast.</p>
</div>
<div class="paragraph">
<p>A transport has two primary roles, the routing of messages between peers and
the managing of protocol dependent subscription management and message framing.
The internal transports (PGM, TCP Mesh) all use the internal protocol semantics
for messaging.  The external bridged transports (RV, NATS, Redis) have
protocols with similarities, but they have unique behaviors that make them more
complicated that the internal transports.</p>
</div>
<div class="paragraph">
<p>The design of the internal transports allow them to be used by any of the
external transports, so RV can use a TCP mesh or PGM multicast or some of
combination of them interconnected.  Similar for NATS and Redis, they can also
use PGM multicast as well as a TCP mesh.  The routing of messages between peers
is agnostic to the type of protocol that the endpoint clients are using.  It is
possible to use the Rai MS protocol directly as well.  The <code>ms_server</code> console
contains the ability to publish, subscribe without using an external client.
The Telnet transport uses the console protocol.  The Web transport serves
builtin html pages that interface with the console protocol through websocket
protocol.</p>
</div>
<div class="paragraph">
<p>There are two sides to transport configuration, the listener and the connector.
Only the internal transports support the connecting side (PGM, mesh, TCP), the
client side (RV, NATS, Redis, Telnet, Web) only uses listeners and do not have
a cost.  The device option will auto-discover a connector or listener via
multicast through a device.  This requires that the connector and listener are
on the same broadcast domain or have multicast routing configured.</p>
</div>
<div class="paragraph">
<p>The config file format is a JSON or YAML with a record that can have these
fields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: &lt;name&gt;
  type: &lt;pgm | mesh | tcp | rv | nats | redis | telnet | web | name&gt;
  route:
    listen: &lt;address&gt;
    connect: &lt;address&gt;
    device: &lt;address&gt;
    port: &lt;number&gt;
    cost: &lt;number&gt;
    &lt;parm&gt;: &lt;value&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>name</code> identifies the transport so that it can be referenced for starting
and stopping in the console and the command line.  It is also used by auto
discovery to match transports and it is sent to other peers so that it can be
read in log files and diagnostic output.  It has no protocol implications
beyond auto discovery, a misspelling won&#8217;t cause it to stop working.</p>
</div>
</div>
<div class="sect2">
<h3 id="service_and_networks">Services and Networks</h3>
<div class="paragraph">
<p>The endpoint protocols: RV, NATS, Redis; all have a service defined to separate
the data flow from one another.  By using the same service name allows these
endpoints to share the same namespace.  The underlay network that connects the
namespaces can both be configured using the YAML files or the console and also
be specified by the connecting clients.  The clients can specify a network with
PGM multicast or with TCP endpoints and meshes.  All of networks specified by a
client that use TCP will still use multicast to resolve the endpoints by
service name by using the name protocol.</p>
</div>
<div class="paragraph">
<p>Networks use a device name and a protocol or a multicast address.  When a
network is not specified by a client or configuration, then the links between
services have to be configured by the YAML files and/or in the console.</p>
</div>
<div class="paragraph">
<p>Example networks and how they are interpreted.  All of these have a service
name associated with the network, which must match for namespace to
communicate.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>eth0;239.1.2.3</code>&#8201;&#8212;&#8201;Connect a PGM protocol to eth0 joining the multicast
address of 239.1.2.3 for communicating with other peers.</p>
</li>
<li>
<p><code>eth0;tcp.listen</code>&#8201;&#8212;&#8201;Connect a name protocol to the eth0 interface and
advertise a TCP listen endpoint.</p>
</li>
<li>
<p><code>eth0;tcp.connect</code>&#8201;&#8212;&#8201;Connect a name protocol to eth0, and advertise a TCP
connection endpoint.  These resolve to a connection when listen endpoints
appear with a clients that use the above.</p>
</li>
<li>
<p><code>eth0;mesh</code>&#8201;&#8212;&#8201;Connect a name protocol to eth0, and advertise a TCP mesh
endpoint.  This creates connections to all other mesh endpoints advertised.</p>
</li>
<li>
<p><code>eth0;any</code>&#8201;&#8212;&#8201;Connect a name protocol to the eth0, and connect to a listen or
a mesh advertised.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The device name eth0 can be substituted with an IPv4 address, like
<code>192.168.1.0;tcp.listen</code>, or a hostname that resolves to an IPv4 address.  If a
network is specified without a name, like <code>;tcp.listen</code>, then the machine&#8217;s
hostname is used to find the device.</p>
</div>
<div class="paragraph">
<p>The configuration for the PGM, name, TCP protocols are generated as needed by
the client if they do not exist.  When a service already is configured, then
it is used instead and the network parameters are ignored.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cost">Cost</h3>
<div class="paragraph">
<p>All of the internal transports have a cost assigned to the links.  The routing
from peer to peer uses this cost to find a path that minimizes the cost.  Equal
cost links are utilized by each peer by encoding a path into the message
header.  This path is enumerated from 0 &#8594; 3, so there is a maximum of 4 equal
cost paths possible between any 2 peers in the network.  The per path cost can
be configured by using different cost metrics for each link.  The default cost
is 1000 so that a configured cost can be less or greater than 1000.  These
configured metrics are replicated throughout the network so that every peer
agrees the cost of every path that exists.  A case where lowering the cost is
useful is when some of the links have higher performance than others as is the
case when all peers exist within a host or within a data center.  A case when
configuring different cost for each of the 4 paths is to load balance multiple
links with equal performance.</p>
</div>
<div class="paragraph">
<p>Example of configuring a lower cost mesh on a bridge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: rv_7500
  type: mesh
  route:
    device: docker0
    cost: 10</pre>
</div>
</div>
<div class="paragraph">
<p>If every container within this host has a RV client that connects with a
network and service of <code>-network eth0;mesh -service 7500</code> then the cost of 10
discovered through the <code>docker0</code> bridge.  The name protocols used will use the
name of the device as their tport name.</p>
</div>
<div class="paragraph">
<p>Example of configuring a load balanced cost for links through a data center:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  transports:
    - tport: a_mesh
      type: mesh
      route:
        listen: *
        connect: [ host, host2, host3, host4 ]
        port: 5000
        cost: [ 100, 1000, 1000, 1000 ]
    - tport: b_mesh
      type: mesh
      route:
        listen: *
        connect: [ host, host2, host3, host4 ]
        port: 5001
        cost: [ 1000, 100, 1000, 1000 ]
    - tport: c_mesh
      type: mesh
      route:
        listen: *
        connect: [ host, host2, host3, host4 ]
        port: 5002
        cost: [ 1000, 1000, 100, 1000 ]
    - tport: d_mesh
      type: mesh
      route:
        listen: *
        connect: [ host, host2, host3, host4 ]
        port: 5003
        cost: [ 1000, 1000, 1000, 100 ]</pre>
</div>
</div>
<div class="paragraph">
<p>This creates 4 equal mesh networks, each of which is preferred for part of the
subject space.  The connect and cost can be enumerated as connect, connect2,
connect3, connect4 and cost, cost2, cost3, cost4 as well as an array.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tcp_encryption">TCP Encryption</h3>
<div class="paragraph">
<p>The TCP type and mesh type links are encrypted using AES 128 bit in counter
mode.  The protocol above the link layer handles the authentication for
trusting the peer and the messages that are received, described in
<a href="#authentication">Authentication</a>.  The encryption is set up by a ECDH exchange.  Each side
generates a ECDH keypair and sends the public key with a checksum and a 128 bit
nonce value.  Each side computes the secret key and uses the KDF to mix the
secret with the nonce value to arrive at a 128 bit key and a 128 bit counter
for sending and receiving.  Thse are used to encrypt and decrypt the other
sides bytes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>alice -&gt; bob [ 8 bytes checksum ] [ 32 bytes pub key ] [ 16 bytes nonce ]
bob -&gt; alice [ 8 bytes checksum ] [ 32 bytes pub key ] [ 16 bytes nonce ]
alice.secret = ECDH( bob public key, alice private key )
bob.secret = ECDH( alice public key, bob private key )
alice.recv key+counter = KDF( secret[32] + bob.nonce[16] ) -&gt; 64 bytes
alice.send key+counter = KDF( secret[32] + alice.once[16] ) -&gt; 64 bytes
bob.recv key+counter = KDF( secret[32] + alice.nonce[16] ) -&gt; 64 bytes
bob.send key+counter = KDF( secret[32] + bob.once[16] ) -&gt; 64 bytes</pre>
</div>
</div>
<div class="paragraph">
<p>The 32 byte secret will be the same on both ends.  The nonce is a random 16
byte value.  The KDF function mixes into the keys a preshared salt value,
generated by ms_key_gen in a "config/.salt" file described in <a href="#config">Configuration</a>.
Without this salt value, the key exchange will compute incorrect keys even
though the secret is computed correctly.</p>
</div>
<div class="paragraph">
<p>The 8 bytes checksum is a CRC of the pub key and the nonce in big endian, so
the first 4 bytes will be zero.  The zero bytes cause an encrypted connection
to an unencrypted endpoint to fail.</p>
</div>
<div class="paragraph">
<p>The 64 byte result of the KDF computation is folded with XOR to arrive at the
16 byte AES key and the 16 byte counter value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_open_pgm">Open PGM</h3>
<div class="paragraph">
<p>PGM is a multicast protocol, which layers reliability on the native UDP
multicast.  The parameters for it declare the amount of memory used for
buffering data and control the timers when retransmitting is necessary.</p>
</div>
<div class="paragraph">
<p>The type of PGM used is UDP encapsulated using the port specified.  The address
specification has a network, a send address, and multiple receive addresses,
formatted as <code>network;recv1,..;send</code>, so this is a valid address:
<code>192.168.1.0;224.4.4.4,225.5.5.5;226.6.6.6</code> where the send address is the last
part and the middle addresses are where packets are received.  If the network
part is unspecified, then the hostname is used to find the interface.  If there
is only one multicast address, then that is used for both sending and
receiving.</p>
</div>
<div class="paragraph">
<p>Example <code>tport_mypgm.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: mypgm
  type: pgm
  route:
    listen: 192.168.1.0;224.4.4.4
    port: 4444
    cost: 100</pre>
</div>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">;239.192.0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">;239.192.0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cost of PGM network</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mtu</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16384</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum UDP packet size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">txw_sqns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4096</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send window size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxw_sqns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4096</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receive window size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">txw_secs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send window in seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mcast_loop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loop through the host</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The transmit and receive window sizes expand to the reliability time or the
<code>txw_secs</code> parameter.  When the <code>txw_secs</code> is not set, then the reliability
passed on the command line or as a configuration parameter is used.  The
receive window memory is not used until there is packet loss and a
retransmission occurs.  Unrecoverable packet loss occurs when the transmission
window no longer has the sequences that are lost.  The <code>mcast_loop</code>, when set
to 2, allows two peers to share the same network on the same host.  This causes
packets to loop back through the interface and allows multiple PGM networks to
coexist on the same multicast group.</p>
</div>
<div class="paragraph">
<p>In addition to the multicast networking, an inbox protocol is used for point
to point messages.  The network specified in the multicast address is used
as the inbox network, with a random port.</p>
</div>
<div class="paragraph">
<p>The listen and connect addresses act similarly, two peers using different
methods will communicate if the multicast send address matches one of the
receive addresses and the inboxes are connected.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tcp_mesh">TCP Mesh</h3>
<div class="paragraph">
<p>A TCP mesh is a group of peers which automatically maintain connections with
every other peer.  When a new peer joins the mesh, it opens a connection with
all the other peers which are currently members of the mesh.</p>
</div>
<div class="paragraph">
<p>The timeout parameter causes the connecting peer to retry for this amount of
time.  When the timeout expires, the transport will not try to connect until
told to do so again.</p>
</div>
<div class="paragraph">
<p>Multiple connect addresses are normally specified so that some connection
likely succeeds if that network is running.  Allow peers can specify multiple
connect addresses since they use both listen and connect methods to join a
network.  After one connection succeeds, all the other connections in progress
are stopped and the list of mesh members are downloaded from the peers and
those are connected.</p>
</div>
<div class="paragraph">
<p>Example <code>tport_mymesh.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: mymesh
  type: mesh
  route:
    listen: *
    connect: [ host, host2, host3, host4 ]
    port: 9000
    timeout: 0
    noencrypt: true</pre>
</div>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passive listener</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">localhost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active joiner</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">device</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use peer discovery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener or connect port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active connect timeout</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cost of mesh links</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">noencrypt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disable encryption</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If the mesh is a stable network, then the timeout set to a larger value or zero
can prevent a network split where some parts of the network are isolated for a
period of time.  When a host is restarted doesn&#8217;t have as much of an effect by
a timeout since it is rejoining an existing network.  If a timeout expires,
then an admin request to rejoin the network is possible through the console.</p>
</div>
<div class="paragraph">
<p>When a <code>device</code> parameter is used, then multicast is used through the name
protocol to discover peers that are joining the same mesh, matching using the
tport name.  After discovering the peer, a connection with TCP is used to join
the mesh.  The port can be random with a device, since the address is
discovered rather than connected.  Both the device and connect can be methods
can be used.</p>
</div>
<div class="paragraph">
<p>The <code>noencrypt</code> parameter set to true disables tcp link encryption.  Both the
listener and connector must match this setting, otherwise they will close the
connection after receiving the first bytes sent.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tcp_point_to_point">TCP Point-to-point</h3>
<div class="paragraph">
<p>A TCP point to point connection to another peer.  This is useful to create
ad-hoc topologies at the network boundaries.</p>
</div>
<div class="paragraph">
<p>Example <code>tport_mytcp.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: mytcp
  type: tcp
  route:
    listen: eth0
    connect: host
    port: 9001
    timeout: 0</pre>
</div>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passive listener</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">localhost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active joiner</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">device</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use peer discovery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener or connect port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active connect timeout</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cost of the TCP link</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">edge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A peer at the edge</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">noencrypt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disable encryption</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A TCP protocol is either a listener or a connector, the appropriate config is
used at run time when a connect or listen is used to activate the port.  When
device is used to discover the peers through the multicast name protocol, the
listeners are matched with the connectors.  When more than one listener is
discovered by a connector, then connections are made to each one.</p>
</div>
<div class="paragraph">
<p>Whether a configuration is used to connect or listen is specified by a listen
or connect command or configuration.  If multiple connections are specified by
the connect parameter, then the first connection that is successful will cause
the others to stop trying to connect.</p>
</div>
<div class="paragraph">
<p>The <code>edge</code> parameter set to true causes the passive peer to pool the
connections on a single transport, similar to a multicast transport where the
traffic is primarily through a gateway peer.  The <code>noencrypt</code> parameter set to
true disables tcp link encryption.  Both the listener and connector must match
this setting, otherwise they will close the connection after receiving the
first bytes sent.</p>
</div>
<div class="paragraph">
<p>If the <code>listen</code> or <code>connect</code> parameters specify a port, as in "localhost:8000",
then that port overides the parameter <code>port</code> configured.  A device name is
resolved before the hostname DNS resolver is tried, so "eth0:8000" will resolve
the address configured on the eth0 device.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tib_rv">Tib RV</h3>
<div class="paragraph">
<p>The RV protocol supports both the RV5 and RV6+ styles of clients.  The RV6+
clients use the daemon for the inbox endpoint and don&#8217;t create sessions, the
RV5 clients use a unique session for each connection and allow an inbox reply
in the subscription start.  These differences cause decades old software
incompatibilities and pressure to re-engineer legacy messaging systems.</p>
</div>
<div class="paragraph">
<p>There clients usually specify the network and service they want to connect,
which is different from the other clients.  When a client requests to connect
to a multicast network, the Rai MS <code>ms_server</code> will start a PGM transport for
it, unless an existing transport is already defined named with a <code>rv_</code> prefix
and a service numbered suffix.</p>
</div>
<div class="paragraph">
<p>When the <code>rv_7500</code> transport exists as a TCP mesh, then this network is
remapped to the predefined transport when a RV client uses the service 7500
and the multicast network specified by the client is ignored.  When no
multicast network is specified, then no Rai MS transport is created and
the existing transports are used.</p>
</div>
<div class="paragraph">
<p>Example <code>tport_myrv.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: myrv
  type: rv
  route:
    listen: *
    port: 7500</pre>
</div>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passive listener</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">use_service_prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use a service namespace</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no_permanent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exit if no connections</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no_mcast</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ignore multicast networking</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no_fakeip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use IPv4 address for session</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Unless the use_service_prefix is false, the traffic is segregated to the
<code>_rv_7500</code> where service is 7500.  If it is true, then all services that also
have use_service_prefix set to true will share the same namespace.  Without
<code>no_fakeip</code> set to true, the session and inbox values are random and not based
on the IPv4 address of the host.  This allows RV networks to work without a
routable IPv4 network across private address spaces that are common with
NATs, VMs, and/or container networks.</p>
</div>
</div>
<div class="sect2">
<h3 id="_nats">NATS</h3>
<div class="paragraph">
<p>NATS is a pub/sub system that is similar to RV with respect to subject schema
with some extensions for queue groups and optionally persistent message
streaming.  The protocol support does not include the streaming components,
only the pub/sub and queue groups.  NATS does not have an inbox point-to-point
publish scheme, it relies on the client to create a unique subject for this
functionality.</p>
</div>
<div class="paragraph">
<p>Example <code>tport_mynats.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: mynats
  type: nats
  route:
    listen: *
    port: 4222</pre>
</div>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passive listener</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_nats</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service namespace</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Join a network</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If the network is specified, then starting the NATS service will also join
the network.  A network format is as described in <a href="#service_and_networks">Services and Networks</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_redis">Redis</h3>
<div class="paragraph">
<p>Redis has a pub/sub component that has slightly different semantics, without a
reply subject for request/reply.  It also uses the term <code>channel</code> to refer to a
subscription.  A pattern subscription is separated by a psub operator, allowing
subscriptions and publishes to any series of bytes.</p>
</div>
<div class="paragraph">
<p>Example <code>tport_myredis.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: myredis
  type: redis
  route:
    listen: *
    port: 6379</pre>
</div>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passive listener</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_redis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service namespace</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Join a network</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The data operators that operate on cached structures like lists and sets, etc.
These commands are available when a shared memory key value segment created and
passed as a command line argument to the server (example: -m sysv:raikv.shm), or
defined as a value in the config files (example: map: "sysv:raikv.shm").</p>
</div>
<div class="paragraph">
<p>If the network is specified, then starting the Redis service will also join
the network.  A network format is as described in <a href="#service_and_networks">Services and Networks</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_telnet">Telnet</h3>
<div class="paragraph">
<p>Telnet is a way to get a console prompt, but it doesn&#8217;t start by default.  It
uses the same transport config as the pub/sub protocols.  It also can be used
by network configuration tools to install a configuration remotely.  A telnet
client signals the service that it has terminal capabilities which enables
command line editing.</p>
</div>
<div class="paragraph">
<p>Example <code>tport_mytelnet.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: mytelnet
  type: telnet
  route:
    listen: *
    port: 22</pre>
</div>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passive listener</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener port</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_web">Web</h3>
<div class="paragraph">
<p>Web handles http requests and websocket endpoints and integrates an web
application that can be used to graph activity and show internal tables.  The
web application is compiled into the server, so no external file access is
necessary.</p>
</div>
<div class="paragraph">
<p>Example <code>tport_myweb.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: myweb
  type: web
  route:
    listen: *
    port: 80
    http_dir: "./"
    http_username: myuser
    http_password: mypassword</pre>
</div>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passive listener</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">http_dir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serve files from this directory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">http_username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds username to digest auth</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">http_password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets password for username</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">http_realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets realm for username</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">htdigest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Load digest file for auth</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If http_dir is not set, then this service does not access the filesystem
for processing http get requests.  It has a set of html pages compiled
into the binary that it uses for viewing the server state.</p>
</div>
<div class="paragraph">
<p>If http_dir is set, then the files located in the directory will override the
internal files.  The html files and websocket requests also have a templating
system which substitute values from the server.  If <code>@(show ports)</code> appears in
a html page, it is replace with a html <code>&lt;table&gt;</code> of ports.  If <code>template "res"
: @{show ports}</code> is sent using a websocket, it expands to a JSON array off
ports and the reply is <code>"res" : [ports...]</code>.</p>
</div>
<div class="paragraph">
<p>Any of the commands from the console interface are now exposed on the http
endpoint.  Requesting "show ports" will respond with a JSON array of transports
with the current totals of messages and bytes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ wget --http-user=myuser --http-password=mypassword -q -O - "http://localhost:80/?show ports"
[{"tport":"rv.0", "type":"rv", "cost":1000, "fd":13, "bs":"", "br":"", "ms":"", "mr":"", "lat":"", "fl":"SLI", "address":"rv://127.0.0.1:7500"},
{"tport":"mesh4.1", "type":"mesh", "cost":1000, "fd":16, "bs":"", "br":"", "ms":"", "mr":"", "lat":"", "fl":"SLX", "address":"mesh://10.4.4.18:19500"},
{"tport":"primary.2", "type":"tcp", "cost":1000, "fd":18, "bs":29500, "br":47324, "ms":229, "mr":355, "lat":"26.5ms", "fl":"C", "address":"robotron.1@tcp://209.237.252.104:18500"},
{"tport":"secondary.3", "type":"tcp", "cost":1000, "fd":20, "bs":23276, "br":39134, "ms":181, "mr":311, "lat":"29.4ms", "fl":"C", "address":"edo.2@tcp://209.237.252.98:18500"}]</pre>
</div>
</div>
<div class="paragraph">
<p>The websocket endpoint can also be used to subscribe subjects.  When a message
is published to the websocket, the format used is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"subject" : { "field" : "value" }</pre>
</div>
</div>
<div class="paragraph">
<p>This requires that the messages published  can be converted to JSON or is
already in JSON format.</p>
</div>
<div class="paragraph">
<p>The http_username / http_password or htdigest will cause http digest
authentication to be used and require them for access.  The above wget is used
with the example configuration.</p>
</div>
<div class="paragraph">
<p>A htdigest file contains a list of users and can be created by the htdigest
program distributed with the Apache packages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ htdigest -c .htdigest realm@raims myuser
Adding password for myuser in realm realm@raims.
New password: mypassword
Re-type new password: mypassword

$ cat .htdigest
myuser:realm@raims:56f52efe43dcf419e991ea6452ae6f06</pre>
</div>
</div>
<div class="paragraph">
<p>Then <code>tport_myweb.yaml</code> is configured like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  tport: myweb
  type: web
  route:
    listen: *
    port: 80
    htdigest: ./.htdigest</pre>
</div>
</div>
<div class="paragraph">
<p>Only one realm can be used by the service.  If http_realm is configured then
that realm is used, otherwise the first realm in the htdigest file is used.  If
no realm is specified but a user and password are specified, then "realm@raims"
is used.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="linkstate">Link State</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_forwarding_set">The Forwarding Set</h3>
<div class="paragraph">
<p>Each node in a network must construct a forwarding set for any message sent by
any peer.  A forwarding set instructs the node where to send a message so that
all subscribers of it will see the message exactly one time, when the network
is converged and stable.</p>
</div>
<div class="paragraph">
<p>A "converged network" is one where all peers agree that a link exists.  If
peer A has in it&#8217;s database a link to peer B, then peer B must also have a
link to peer A.  If a link is missing, then the network tries to resolve the
difference by asking the peers with the discrepancy which is correct.</p>
</div>
<div class="paragraph">
<p>Every peer has a bloom filter that contains all of the subscriptions currently
active.  The links database tells each peer how the network can be traversed
for full coverage and the bloom filter prunes the coverage by dropping the
message when there are no subscriptions active that match the subject on the
other side of the link.</p>
</div>
<div class="paragraph">
<p>A simple redundant network is a circle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dyna  --  ruby

  |        |

bond  --  chex</pre>
</div>
</div>
<div class="paragraph">
<p>If the cost of each of the links is set to the default 1000, then the
forwarding set for dyna is the link to ruby and bond.  When ruby and bond
receive a message from dyna, only one of them will forward the message to chex.
The path cost from dyna &#8594; ruby &#8594; chex is equal to the path cost from dyna &#8594;
bond &#8594; chex.  The forwarding algorithm tracks the equal cost paths and ranks
them in order of peer age.  In the case that ruby is older than bond, then the
ranking of these routes would by 1. dyna &#8594; ruby &#8594; chex and 2. dyna &#8594; bond &#8594;
chex.  The top 4 ranked routes are saved as the forwarding sets, and selected
by the hash of the message subject.  In this case, half of the subjects
subscribed by chex and published from dyna would take the first path and the
other half would take the second path.</p>
</div>
<div class="paragraph">
<p>The method of ranking the paths by peer age is used because the stability
of the network is less affected when more transient peers are added and
subtracted from the link state database.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="message_loss">Message Loss</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Under normal conditions, the sequence of the message is one greater than the
last sequence received.  The sequence numbers are 64 bits so they will never be
zero.  These conditions are possible when a sequence is not in incrementing
order from the last message received, which is what normally occurs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Publisher includes a time stamp</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This causes the subscriber to synchronize the sequence numbers.  The publisher
will always include a time stamp when the first message of a subject is
published, or when the last sequence is old enough to be cycled from the
publisher sequence window.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first message received</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a subscription start occurs it will usually not contain a time stamp,
unless it is the first message published.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The message sequence is repeated</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A sequence is less than or equal the last sequence received.  This indicates
the message was already processed.  The message is dropped.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The message sequence skips ahead</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some sequences are missing, indicating messages were lost.  Notification of
message loss is propagated to the subscriptions.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The message subject is not subscribed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The subscription may have dropped and the publisher has not yet seen the
unsubscribe.</p>
</div>
<div class="sect2">
<h3 id="_multicast_sequence_numbers">Multicast sequence numbers</h3>
<div class="paragraph">
<p>The sequence numbers include a time frame when the publisher starts the
message stream.  This is the computation that creates a new sequence stream.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>nanosecond time stamp = 1659131646 * 1000000000 = 0x17066b710b706c00

 1               8               16              24
|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-
|0 0 0 1 0 1 1 1 0 0 0 0 0 1 1 0 0 1 1 0 1 0 1 1 0 1 1 1 0 0 0 1
|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-
 32              40              48              56              64
 -+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|
 0 0 0 0 1 0 1 1 0 1 1 1 0 0 0 0 0 1 1 0 1 1 0 0 0 0 0 0 0 0 0 0|
 -+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|

message sequence number = ( nano time &gt;&gt; 33 &lt;&lt; 35 ) + 1 = 0x5c19adc000000001

 1               8               16              24
|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-
|0 1 0 1 1 1 0 0 0 0 0 1 1 0 0 1 1 0 1 0 1 1 0 1 1 1 0 0 0 0 0 0
|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-
 32              40              48              56              64
 -+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1|
 -+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|</pre>
</div>
</div>
<div class="paragraph">
<p>This truncates nanosecond time stamp to approximately 10 second intervals, a
new time frame can only occur after 10 seconds.  The time frame is stored in
the upper 29 bits will be valid until the year 2115.  The sequence resolution
within a time frame is 35 bits or 34 billion sequences.  These are rotated to
new time frames when the sequence number is zero.</p>
</div>
<div class="paragraph">
<p>These are properties of the time frame encoded in the message sequence numbers:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A start of a new multicast stream sequence will use the current time, this
is always after the last convergence time stamp.  The current time is also used
as needed when memory limitations prevent caching of the last sequence
published.  When the sequence is cached, the additional messages won&#8217;t change
the time frame but will increment the sequence number.</p>
</li>
<li>
<p>A new subscription start or uncached sequence publish can verify that the
first message received is greater than the network convergence time.  This is
used to validate that the message stream is uninterrupted to the start of the
time frame, since message loss has not occurred since the before network
convergence.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>All of the transports are stream oriented, so a loss of unrecoverable network
packets will cause connections to drop and a new convergence state by pruning
the lost routes.  All peers will agree on a time that convergence is reached.
New time frames are created for all messages published so that the time frame
constructed in any one peer greater than the convergence time in all peers.</p>
</div>
<div class="paragraph">
<p>When routes are added to or subtracted from the network, the message routing is
not stable until all peers have finished adjusting their view of the network.
The peer that publishes a message may use a sub-optimal forwarding path to the
recipients until they are notified that better paths are available with link
state exchanges.</p>
</div>
<div class="paragraph">
<p><a href="#pub_window">[pub_window]</a>
Publish sequence window
<sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub>~~</p>
</div>
<div class="paragraph">
<p>A map of subject to sequence numbers for published multicast messages is
maintained by each peer.  This map rotates when a configured memory limit is
reached, <code>pub_window_size</code>, and the window time interval is greater than a
configured time, <code>pub_window_time</code>, which must be at least 10 seconds.  When a
subject is rotated out of the window, the sequence number is restarted with a
new time frame.</p>
</div>
</div>
<div class="sect2">
<h3 id="_subscription_sequence_window">Subscription sequence window</h3>
<div class="paragraph">
<p>A map of subject to sequence numbers for the subscriptions that a peer has
is also maintained.  This validates that the messages are processed in order
and allows notification of message loss when the sequences skip and does not
allow a message to be processed twice.  The memory limit for this is
<code>sub_window_size</code> and time limit is <code>sub_window_time</code>.  When a subject is
rotated out of the window, then the publisher did not update for the window
time and the next sequence is treated as if a new subscription was created.</p>
</div>
<div class="paragraph">
<p>Message duplicates are avoided by discarding messages that are older than the
trailing edge of the subscription sequence window.  The clock skew between
systems is estimated.  The console command <code>show skew</code> will display the
calculated clock skew between systems.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>C.test[Jl8gk4f+gVaf60LxKtsaMg]@dyna[560]&gt; show skew
user |   lat  |   hb   | ref |  ping  |   pong  |     time
-----+--------+--------+-----+--------+---------+-------------
 A.1 |  187us |  451us |   0 |  104us | -2.22us | 01:32:56.384
 B.2 |  304us | 1.25ms |   1 |  207us | -18.9us | 01:32:56.384
 D.3 |  174us |  690us |   0 | 77.2us | -3.73us | 01:32:56.384
 G.4 | 25.8ms |  4.5se |   1 |  4.5se |  4.49se | 01:32:51.897</pre>
</div>
</div>
<div class="paragraph">
<p>The pong calculation subtracts the round trip time and is the most accurate,
the others disregard the latency of the network.  The HB are from time
differences of directly attached peers using heartbeats and are shared with
those not directly attached.  The ref is the peer (0 = self, 1 = A.1) that
originated the HB difference.  The time is the estimated clock setting of the
remote peer in the current timezone.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_for_sequence_windows">Configuration for sequence windows</h3>
<div class="paragraph">
<p>The sizes and windows are in the parameters section of the config file and
default to 4 megabyte (about 60,000 subjects for publishers and 20,000 for
subscribers) and 10 seconds.  The size of the windows will have an overhead of
48 bytes for publishers and 128 bytes for subscribers in addition to the
subject size.  The 10 second rotate timer could cause more memory to be used if
lots of new subjects are published or lots of new subjects are subscribed
within 10 seconds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cat config/param.yaml
parameters:
  pub_window_size: 10 mb
  pub_window_time: 60 sec
  sub_window_size: 10 mb
  sub_window_time: 60 sec</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_show_loss">Show loss</h3>
<div class="paragraph">
<p>The <code>show loss</code> console command displays the messaging statistics for the
peers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>A.test[XftVokMK+WK12CNuEaRFuA]@dyna[545]&gt; show loss
user | repeat | rep time | not sub | not time |  msg loss |   loss time  | ibx loss | ibx time
-----+--------+----------+---------+----------+-----------+--------------+----------+---------
 B.1 |      0 |          |       0 |          |         0 |              |        0 |
 D.3 |      0 |          |       0 |          |       766 | 20:42:24.431 |        0 |
 C.4 |      0 |          |       0 |          |         0 |              |        0 |</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>repeat&#8201;&#8212;&#8201;count of multicast messages received more than one time</p>
</li>
<li>
<p>rep time&#8201;&#8212;&#8201;last time of repeated messages</p>
</li>
<li>
<p>not sub&#8201;&#8212;&#8201;count of multicast messages received which were not subscribed</p>
</li>
<li>
<p>not time&#8201;&#8212;&#8201;last time of not subscribed</p>
</li>
<li>
<p>msg loss&#8201;&#8212;&#8201;number of multicast messages which were lost</p>
</li>
<li>
<p>loss time&#8201;&#8212;&#8201;last time of multicast message loss</p>
</li>
<li>
<p>ibx loss&#8201;&#8212;&#8201;number of messages which were lost from the inbox stream</p>
</li>
<li>
<p>ibx time&#8201;&#8212;&#8201;last time of inbox message loss</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An inbox message loss is not unusual since the point to point messages are
often used for link state exchanges and other network convergence functions.
Inbox message loss is usually not as problematic as multicast message loss
since there often timers are retries associated with their usage.</p>
</div>
<div class="paragraph">
<p>Multicast message loss is much more difficult to recover from, since there
are usually many multicast streams and tracking the state of each one is
a problem solved by persistent message queues.  This requires clients
which track the state of the messages they consume and notify the queue when
they are finished with processing them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_notification_of_message_loss">Notification of message loss</h3>
<div class="paragraph">
<p>If a message arrives with a sequence which is not in order, it is forwarded
with state indicating how many messages are missing, if that can be determined.
The protocol handling of this notification is to publish a message indicating
how many messages were lost.</p>
</div>
<div class="sect3">
<h4 id="_rv_protocol">RV protocol</h4>
<div class="paragraph">
<p>The RV protocol publishes a message to the
<code>_RV.ERROR.SYSTEM.DATALOSS.INBOUND.BCAST</code> subject with a count of lost messages.
These are throttled so that on one is published per second after the first one
is published.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   mtype : "A"
     sub : _RV.ERROR.SYSTEM.DATALOSS.INBOUND.BCAST
    data : {
   ADV_CLASS : "ERROR"
  ADV_SOURCE : "SYSTEM"
    ADV_NAME : "DATALOSS.INBOUND.BCAST"
    ADV_DESC : "lost msgs"
        lost : 7
     sub_cnt : 7
        sub1 : "RSF.REC.PAC.NaE"
       lost1 : 1
        sub2 : "RSF.REC.MTC.NaE"
       lost2 : 1
        sub3 : "RSF.REC.MCD.NaE"
       lost3 : 1
        sub4 : "RSF.REC.MCD.N"
       lost4 : 1
        sub5 : "RSF.REC.SPM4.NaE"
       lost5 : 1
        sub6 : "RSF.REC.MER.NaE"
       lost6 : 1
        sub7 : "RSF.REC.MER.N"
       lost7 : 1
        scid : 7500
  }</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_internal_protocol">Internal Protocol</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The protocol is asynchronous with timers to timeout RPCs and to throttle the
rate which peers back off retries.  As a result of this, the message flow for
a network configuration is variable and can change with different conditions.</p>
</div>
<div class="paragraph">
<p>The function of each message is encoded in the subjects with the arguments
passed as field values with some common flags and options encoded in the
message header.</p>
</div>
<div class="paragraph">
<p>Each message is authenticated a session key using a message HMAC.  The initial
key exchange is signed by either the service private key or a configured user
private key.  The heartbeat messages are also authenticated with a hello key
message HMAC derived from the service public key and the start time.  These are
messages that set up the initial key exchange before a session key is
established, but can be weakly authenticated since service public key is
encrypted at rest in the configuration and not shared over the network.</p>
</div>
<div class="paragraph">
<p>Any message that fails authentication is ignored.</p>
</div>
<div class="sect2">
<h3 id="_field_values">Field Values</h3>
<div class="paragraph">
<p>Each field in a message is encoded with a type and length.  This allows new
fields to be added without disrupting the message parsing.  The first 16 bits
encodes the type, length and field id.  The rest of the field encodes the
value.  All integers are encoded in big endian.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>fid = BRIDGE(3), type = OPAQUE_16(4) ( opaque 16 bytes )            144
|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+.. +
|1 1 x x 0 1 0 0 0 0 0 0 0 0 1 1|                                     |
 ^ ^     ^.....^ ^.............^ ^....................................
 | |         |        |                        |
 | primitive type(4)  fid(3)               128 bit bridge
 fixed</pre>
</div>
</div>
<div class="paragraph">
<p>The types defined are bool (size:1), unsigned int (size:2,4,8), opaque
(size:16,32,64), string (max size:64k), long opaque (max size:4G).</p>
</div>
<div class="paragraph">
<p>The first two bits, fixed and primitive, indicate whether the type has a fixed
length, and whether the value is a field (primitive) or a message (not
primitive).  A message is another group of fields and is always encoded as a
long opaque with the primitive bit set to 0.  A message payload is always
encoded as a long opaque with the primitive bit set to 1.</p>
</div>
<div class="paragraph">
<p>The types are enumerated as:</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Size</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 byte</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unsigned short</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unsigned int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unsigned long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">opaque 16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">opaque 32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">opaque 64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16 bit length + up to 64K bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">long opaque</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32 bit length + up to 4G bytes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The field values are aligned on 2 byte boundaries, so the value is padded one
byte when the value size is odd.  There are currently 76 different field ids
(fid) and a maximum of 256 (defined in the header file <code>msg.h</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_message_framing">Message Framing</h3>
<div class="paragraph">
<p>A message frame has 5 fixed length sections and 3 fields that are always
present and use two bytes.</p>
</div>
<div class="paragraph">
<p>These header fields are:</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Size</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 bit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 bits</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Option</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 bits</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subject Hash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bridge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 byte type + 16 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Digest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 byte type + 16 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 byte type + 16 bit length + up to 64K</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The first 4 bytes encoded as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bytes 0 -&gt; 3 are ver(1), type(2), opt(5), message size (24)
 1               8               16              24              32
|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|-+-+-+-+-+-+-+-|
|1|0 0|0 0 0 0 0|0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0|
 ^ ^.^ ^.......^ ^.............................................^
 |    \    |                         |
ver(1)|   opt(0)                24 bit size(160)
     type(0)</pre>
</div>
</div>
<div class="paragraph">
<p>The Message Type encodes 4 classes of messages:</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mcast</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast message with routeable payload</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inbox</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Point to point message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Router Alert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System link state or subscription update</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heartbeat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Neighbor link keep alive</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A message that has routeable data always has the Multicast or Inbox type set.
The Inbox type message is also used for RPC style communication between peers.
The Router Alert type message alters the routing database by modifying the link
state or the subscription state.  A Heartbeat type is a periodic presence
update.  The peers which are directly connected are responsible for detecting
link failures.</p>
</div>
<div class="paragraph">
<p>The Option Flags is a bit mask that encodes options for messages with Multicast
and Inbox types that are routing data payloads to endpoints.
These are:</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoints ack the reception</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All peers along the route ack the reception</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message is an anycast, destination is one endpoint of many</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MC0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message is using multicast path 0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MC1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message is using multicast path 1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MC2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message is using multicast path 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MC3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message is using multicast path 3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The message size does not include the first 8 bytes, so the message frame size
is 8 + the message size field.  If the size is greater than 24 bits, then the
next 32 bits are used to encode the size and the subject hash is calculated
from the subject.</p>
</div>
<div class="paragraph">
<p>The Bridge, Message Digest and Subject are encoded in Type Length Value format.
The Bridge is a 128 bit identity of the sender.  The Message Digest is the
authentication field.  The receiving peer will authenticate that the message is
valid by using the Bridge to look up the 512 bit session key of the sender and
calculate an HMAC using the message data with the session key and compare it
to the value contained in the Message Digest.  In addition, there are sequence
numbers and time stamps present that prevent the replay of each message frame.</p>
</div>
<div class="paragraph">
<p>The 4 multicast path options will select the one of the equal cost paths
calculated from the current link state.  Every peer can calculate these paths
using the same replicated link state database, this results in 4 forwarding
trees to the same destinations if there are enough redundant links.</p>
</div>
</div>
<div class="sect2">
<h3 id="_system_subjects">System Subjects</h3>
<div class="paragraph">
<p>The peers exchange messages to authenticate new peers, synchronize the link
state of the network, subscription updates, and heartbeats to maintain neighbor
links.  These types of messages have unique subject prefixes as well as bits in
the message type header indicating whether it is special.</p>
</div>
<div class="paragraph">
<p>There are 7 classes subject prefixes used:</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Prefix</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inbox point to point</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_M.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generic multicast message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_X.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heartbeat link presence message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link state broadcast message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_S.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Normal subscription broadcast message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_P.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pattern subscription broadcast message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_N.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Peer statistics multicast message</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A broadcast style forwarding used by _Z, _S, _P subjects is different from
multicast forwarding.  It will flood the authenticated peers in the network,
adjusting each peer&#8217;s routing database as it is received.  It uses this type of
forwarding because this kind of update may cause the multicast forwarding to be
temporarily incomplete until the network converges again.</p>
</div>
<div class="paragraph">
<p>The forwarding path for the Inbox, Heartbeat and broadcast subjects does not
follow the multicast forwarding path, so they can&#8217;t be subscribed.</p>
</div>
<div class="paragraph">
<p>There is a separate sequence number domain defined for these because of the
idempotent nature of maintaining the replicated state of the network.  If a
peer misses messages for a delta changes in the subscriptions or links
database, the state is reinitialized by replicating it from an up to date peer.</p>
</div>
<div class="paragraph">
<p>The multicast subjects follow normal forwarding rules.  The _M prefix is used
for a multicast ping.</p>
</div>
<div class="paragraph">
<p>The _N prefix has unique subjects for link and peer statistics like messages
sent or received, bytes sent or received, as well as adjacency notifications.
These are used to monitor an individual node or a group of them with pattern
subscriptions.  These stats are not sent unless there are subscriptions open.</p>
</div>
</div>
<div class="sect2">
<h3 id="_heartbeat_subjects">Heartbeat Subjects</h3>
<div class="paragraph">
<p>These are sent on a link between directly connected peers.</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subject</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_X.HELLO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First message sent</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_X.HB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Periodic message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_X.BYE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last message sent</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_X.NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link discovery message</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>_X.HELLO and _X.HB messages have two functions, the first is to initiate the
authentication key exchange.  The second is to keep a peer up to date with
the last sequence numbers used by the subscription and link state.  When
heartbeats are not received within 1.5 intervals.  The interval default is 10
seconds, this causes a link to be deactivated at :15 when HB expected at :10.
When all of the direct links to a peer are inactive, then the peer is
unauthenticated and marked as a zombie.  The heartbeat timeout does not
depend on a transport timeout, like a TCP reset.  The result of this behavior
is that overloaded or congested links that delay messages for longer than the
1.5 times the heartbeat interval will may incur message loss.  This puts an
upper bound on the link latency and alleviates back pressure to the publisher.</p>
</li>
<li>
<p>_X.BYE causes the peer to be unauthenticated and dropped from the peer db.</p>
</li>
<li>
<p>_X.NAME messages are multicast to a device for presence detection.  Links
between peers are only established when the type and name of a transport is
matched within a service.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_link_state_subjects">Link State Subjects</h3>
<div class="paragraph">
<p>These are broadcast flooded to authenticated peers.</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subject</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">New peer added to peer db</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.DEL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dropped peer from peer db</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.BLM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subscription bloom filter resized</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADJ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adjacency changed, link added or removed</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>_Z.ADD is broadcast when a new peer is added to the peer db, usually as a
result of authentication and also in the case when network splits and peers
were joined again.</p>
</li>
<li>
<p>_Z.DEL is broadcast when a peer sent a _X.BYE or if it is no longer reachable
because all routes to it are down.</p>
</li>
<li>
<p>_Z.BLM is broadcast when a peer resizes the bloom filter associated with the
subscriptions and patterns it has open, this occurs approximately when
crossing powers of two subscription counts (currently at 31, 62, 124, 248,
&#8230;&#8203;).</p>
</li>
<li>
<p>_Z.ADJ notifies when a peer adds are subtracts a link to another peer.  It
increments the link state sequence number so that peers apply this update
only when the link state reflects the current state, otherwise a RPC
synchronization request is used (_I.[bridge].sync_req) to resync.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_subscription_subjects">Subscription Subjects</h3>
<div class="paragraph">
<p>These are broadcast flooded to authenticated peers.  They are updates to the
bloom filter that can be missed and resynchronized with _Z.BLM or a resync
RPC request.</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subject</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_S.JOIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start a subscription</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_S.LEAV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop a subscription</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_P.PSUB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start a pattern subscription</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_P.STOP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop a pattern subscription</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>_S.JOIN and _S.LEAV add and subtract subscriptions to a subject.</p>
</li>
<li>
<p>_P.PSUB and _P.STOP add and subtract pattern subscriptions.  These contain
a pattern type as well as the pattern string.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_inbox_subjects">Inbox Subjects</h3>
<div class="paragraph">
<p>The format of a subject with an _I. prefix also encodes the destination of the
message by appending the 128 bridge id in base64.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>_I.duBVZZwXfwBVlYgGNUZQTw.auth</pre>
</div>
</div>
<div class="paragraph">
<p>All of the peers along the path to the destination use this bridge id to
forward the message using the rules for the point to point route of the
destination peer.  This may be a TCP link or it may be a UDP Inbox link in the
case of a multicast PGM transport.  The suffix of the inbox subject indicate
the type of request or reply it is.  If the suffix is an integer then the
endpoint is not a system function, but information requested by the console
session or a web interface that is usually converted to text and displayed.</p>
</div>
<div class="paragraph">
<p>These suffixes are currently recognized:</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Suffix</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">auth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request authentication, peer verifies with user or service pub key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">subs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request and match active subscriptions strings with a pattern</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ping</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request a pong reply, also has seqnos for maintaining state</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A reply to a ping, has latency information and update clock skew</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remote admin request, run a console command from another peer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">add_rte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">After authenticated with peer, it will add other peers it knows</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sync_req</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Peer sends when it finds an old peer db or subscription state</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sync_rpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response to a sync_req, includes current state if it is out of date</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bloom_req</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Peer requests bloom state, currently peers use adj_req instead</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bloom_rpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response to a bloom_req, contains the bloom map of the subscriptions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">adj_req</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Peer requests when it finds an old link state or subscription state</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">adj_rpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response to adj_rpy, contains an up to date link state and bloom map for peer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mesh_req</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Peer requests when it detects a missing mesh member</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mesh_rpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response to mesh_rpy, contains missing link URLs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">trace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response to messages which have the Trace option flag in header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response to messages which have the Ack option flag in header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">any</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encapsulates a peer _INBOX message, for point to point routing</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Auth does a key exchange between two peers.  After completing successfully,
each peer has a session key for the other.  This allows messages to be
sent by the other to be authenticated using Message Digest field.</p>
</li>
<li>
<p>Subs is a request for the open subscriptions.  It is used by the console and
the web interface for examining the network.  The RPC reply is always a
numeric string to forward to the terminal or web page that requested it.</p>
</li>
<li>
<p>Ping and pong are latency gathering functions for any two peers in the
network, not necessarily directly connected.  The current sequence numbers
for the link state and subscription state are also exchanged for synchronizing
peers which are not directly connected.</p>
</li>
<li>
<p>Rem is a remote console command execution, used in the console and web
interfaces.</p>
</li>
<li>
<p>Add_rte is used after the auth key exchange to replicate the peer db to a new
peer.  This initial peer db only contains the names and bridge ids, so the
new peer must request session keys, link state and subscription state for
peers it does not already know about.</p>
</li>
<li>
<p>Sync_req and sync_rpy are used replicate the session keys.  If a new peer
does not have the session info from a _Z.ADD or a add_rte, it will request it
from the peer that notified of the unknown peer session.  This will often be
the case after authentication occurs and the new peer receives an add_rte
from an older peer that has a db with the current state of the network.  This
is the only other way that the unique session keys for each peer is
distributed besides directly authenticating with a key exchange.  The sync_rpy
also includes the link state and subscription bloom filter of requested peer.</p>
</li>
<li>
<p>Bloom_req and bloom_rpy are RPCs for the subscription bloom filter.  The
adj_req and adj_rpy are used instead for this info.</p>
</li>
<li>
<p>Adj_req and adj_rpy are the main method that peers recover the current link
state and subscription state.  They work in a RPC request/response style.
The request contains the sequence numbers that the source peer has in it&#8217;s
db.  The destination peer compares these numbers with it&#8217;s own db and replies
when a sequence needs updating.  Usually the destination peer is the one that
the source needs synchronized, but a closer peer can be queried as well.
This occurs when a lot of peers need to resynchronize as a result of a
network split and reconnect.</p>
</li>
<li>
<p>Mesh_req and mesh_rpy are RPCs for distributing URLs for peers in the same
mesh network.  When a peer connects to a mesh, it uses the initial connection
to find the addresses of all the other peers in the mesh with this RPC.</p>
</li>
<li>
<p>Trace and ack are sent as a multicast message is forwarded with the Message
Options set in the header.  These can be requested from a console publish
using the "trace" or "ack" commands.</p>
</li>
<li>
<p>Any encapsulates an _INBOX point to point message and forwards it to the
correct peer.  An _INBOX publish does not have a destination other than a
unique subject that another peer has subscribed, for example
"_INBOX.7F000001.2202C25FE975070A48320.&gt;".  The peer that encapsulates this
message finds the possible destinations by testing the bloom filters it has
and then forwards to the matching peers.  The usual case is that there is
only one matching destination.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="example_message_flow">Example Message Flow</h3>
<div class="paragraph">
<p>Two peers key exchange, ruby connecting to dyna:</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Packet</th>
<th class="tableblock halign-left valign-top">Subject</th>
<th class="tableblock halign-left valign-top">Source</th>
<th class="tableblock halign-left valign-top">Destination</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_X.HELLO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">initial hello message after connection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.xq6vl+2HcoDxtt+7lC7dGQ.auth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna authenticates with ruby</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.wwEnbQEY2FMuwZGSjpi3jQ.auth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby authenticates with dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby adds dyna to peer db</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADJ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby adds link to dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADJ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna adds link to ruby</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.xq6vl+2HcoDxtt+7lC7dGQ.auth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna confirms authentication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna adds ruby to peer db</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Ruby connecting dyna, a member of a network of 4 nodes: dyna, zero, one, and
two.  This is the message flow between ruby and dyna, which completes the initial
synchronization of ruby.</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Packet</th>
<th class="tableblock halign-left valign-top">Subject</th>
<th class="tableblock halign-left valign-top">Source</th>
<th class="tableblock halign-left valign-top">Destination</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_X.HELLO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">initial hello message after connection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.q6pEpnzNyANEZKKp29532Q.auth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna authenticates with ruby</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.tXB702RHKF0M69dl7K7vrw.auth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby authenticates with dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby adds dyna to peer db</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADJ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby adds link to dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.tXB702RHKF0M69dl7K7vrw.adj_req</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby requests adjacency of dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADJ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna adds link to ruby</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.q6pEpnzNyANEZKKp29532Q.auth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna confirms authentication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna adds ruby to peer db</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.q6pEpnzNyANEZKKp29532Q.add_rte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna populates ruby peer db of other peers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.q6pEpnzNyANEZKKp29532Q.adj_rpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna replies to adj_req, links to other peers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.tXB702RHKF0M69dl7K7vrw.sync_req</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby requests sync of peer zero from dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.tXB702RHKF0M69dl7K7vrw.sync_req</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby requests sync of peer one from dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.tXB702RHKF0M69dl7K7vrw.sync_req</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby requests sync of peer two from dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.q6pEpnzNyANEZKKp29532Q.sync_rpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna replies key, links, bloom for peer zero</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.q6pEpnzNyANEZKKp29532Q.sync_rpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna replies key, links, bloom for peer one</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.q6pEpnzNyANEZKKp29532Q.sync_rpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna replies key, links, bloom for peer two</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There is also message flow between dyna and zero, one, two.  This is the flow between dyna and zero.  The
message flow between dyna and one, dyna and two is the same as dyna and zero.</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Packet</th>
<th class="tableblock halign-left valign-top">Subject</th>
<th class="tableblock halign-left valign-top">Source</th>
<th class="tableblock halign-left valign-top">Destination</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADJ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna notifies the new link from dyna to ruby</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna notifies the add ruby to peer db</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADJ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ruby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">forward from ruby for new link from ruby to dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.tXB702RHKF0M69dl7K7vrw.sync_req</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero requests sync of peer ruby from dyna</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_I.ia988C6TtC6/L3JC6D3GqA.sync_rpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna replies key, links, bloom for peer ruby</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_Z.ADD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dyna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero notifies the add of ruby to peer db</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Adding ruby to the network ripples through the directly connected peers, which
discover the new peer from the broadcasting of the _Z.ADD messages and then
synchronize with each other to merge the ruby session key, the link state, and
the subscription bloom state into the network state.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rvd">rvd Compatibility</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_rvd_arguments">rvd Arguments</h3>
<div class="paragraph">
<p>If <code>ms_server</code> is started in <code>rvd</code> compatible mode, it will automatically start
a rv protocol on 7500 and a web service on 7580 unless arguments are present
that modify this.  The protocol that is used between daemons is not compatible
with <code>rvd</code>, but it does allow <code>rv</code> clients to connect and communicate.  In
other words, the client side is compatible, but the network side is not.</p>
</div>
<div class="paragraph">
<p>These arguments are recognized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ms_server -help
   -cfg               : config dir/file (default: exe_path/rv.yaml)
   -reliability       : seconds of reliability (default: 15)
   -user user.svc     : user name (default: hostname)
   -log               : log file
   -log-rotate        : rotate file size limit
   -log-max-rotations : max log file rotations
   -no-permanent      : exit when no clients
   -foreground        : run in foreground
   -listen            : rv listen port
   -no-http           : no http service
   -http              : port for http service (default: listen + 80)
   -no-mcast          : no multicast
   -console           : run with console</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_service_key_configuration">Service Key Configuration</h3>
<div class="paragraph">
<p>Without any arguments, the config file <code>rv.yaml</code> is loaded from the directory
that <code>ms_server</code> is installed.  This config file can be generated with the
<code>ms_gen_key</code> program.  It should be the same for each instance that is joining
the same network and service, since it contains the service key pair that
authenticates the daemon with other daemons located on the network.</p>
</div>
<div class="paragraph">
<p>If <code>ms_server</code> is installed in <code>/usr/local/bin</code> then this can generate the
default config file for it in <code>rvd</code> mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ms_gen_key -y -s rvd -o /usr/local/bin/rv.yaml
create dir  config                  -- the configure directory
create file config/.salt            -- generate new salt
create file config/.pass            -- generated a new password
create file config/config.yaml      -- base include file
create file config/param.yaml       -- parameters file
create file config/svc_rvd.yaml     -- defines the service and signs users
done
- Output config to "/usr/local/bin/rv.yaml"</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>/usr/local/bin/rv.yaml</code> file must be installed on every machine that
connects to the network and expects to communicate with the initial machine.
The contents define the service key pair:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cat /usr/local/bin/rv.yaml
services:
  - svc: rvd
    create: 1663653977.579093187
    pri: QQ5FR17BZktlJnxW/Ln3YExIoq12rf725FEysQwjGJRSNmgskzUA70fQCivq...
    pub: IskYDB7cvb1TIiaGZQ7ZAtWAlwhvGa/7rEfyiRKVp2U10sH3Yl6Eo19c0J1V...
parameters:
  salt_data: hDqyoJ9JSXEEBpiueoNPDEqxy3nsEOt7uoDrSvn4DlSvrLZDNQKG3fmK...
  pass_data: M+ALrLzVLaf/2OlRd7FTstX6pzAF66KQR86EhCxlwXY</pre>
</div>
</div>
<div class="paragraph">
<p>The above service key pair is unique for every <code>ms_gen_key</code> execution.  The
private key is used to sign the authentication messages exchanged between
daemons, and the public key is used to verify that the peer is allowed to
exchange messages on the network.  Unauthenticated peers will be ignored.</p>
</div>
</div>
<div class="sect2">
<h3 id="_starting_in_rvd_compatibility_mode">Starting in rvd Compatibility Mode</h3>
<div class="paragraph">
<p>If the <code>ms_server</code> is linked to <code>rvd</code> and run that way, it will run in
compatibility mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ln -s /usr/local/bin/ms_server /usr/local/bin/rvd
$ /usr/local/bin/rvd
rvd running at [::]:7500
web running at [::]:7580
moving to background daemon</pre>
</div>
</div>
<div class="paragraph">
<p>Unless the -foreground or the -console options are used, it forks itself to
release from the terminal that it is started.  <code>ms_server</code> will also run in
compatibility mode when an argument above is used, for example, <code>ms_server
-listen 7501 -http 7581 -reliability 60</code> will run in compatible mode.</p>
</div>
<div class="paragraph">
<p>If there is already a <code>rvd</code> running on port 7500, it will fail to start and
exit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ rvd
0919 23:13:08.635! rvd.0 listen *:7500 failed
0919 23:13:08.635! web: failed to start web at *.7580</pre>
</div>
</div>
<div class="paragraph">
<p>A HUP signal will cause it to exit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ killall -HUP rvd</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_connecting_to_networks">Connecting to Networks</h3>
<div class="paragraph">
<p>The network parameter that the client specifies controls which network that
the <code>ms_server</code> joins.  It can specify a multicast address, TCP connections, or
a TCP mesh.  Only daemons which connect to the same network will communicate.</p>
</div>
<div class="paragraph">
<p>The formats of these are:</p>
</div>
<table class="tableblock frame-all grid-cols stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Network</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0;239.192.0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PGM multicast address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0;mesh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mesh network</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0;tcp.listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP listen</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0;tcp.connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP connect</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ANY connect</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(empty)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no network</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A mesh network causes all the daemons to connect with one another by listening
to a random port and multicasting that port to eth0.  When other daemons
receive this message, they will establish TCP connections with each other
daemon.</p>
</div>
<div class="paragraph">
<p>A TCP network causes the listeners to multicast their random ports to eth0.
When daemons that have tcp.connect as a network receive this message, they will
connect to the listener.  Multiple TCP listeners can exist on the same network.
The result of having two "eth0;tcp.listen" specifications and two
"eth0;tcp.connect" would be that both connectors will establish connections to
both of the listeners.</p>
</div>
<div class="paragraph">
<p>The PGM multicast address uses UDP encapsulated multicast on the service port
using OpenPGM and a UDP point to point protocol for inbox messaging.</p>
</div>
<div class="paragraph">
<p>The sockets will be bound to the eth0 interface with random ports, except for
the PGM socket, which uses a wildcard address for joining the multicast and the
service port for sending messages.  Multiple services can join the same
network, so -service 7500 and -service 7600 can coexist using the same network
specification.</p>
</div>
<div class="paragraph">
<p>When two <code>ms_server</code> instances are using the network "eth0;mesh" on service
7500 and service 7600, the ports console command will show these networks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>host1_7500.rv[+u7D0t7Cf5MP2USlooBtyA]@host1[632]&gt; ports
   tport  | type | cost | fd | ... |  fl  |                   address
----------+------+------+----+-----+------+-------------------------------------------
    rvd.0 |   rv |      | 13 |     |  SLI |                             rv://[::]:7500
rv_7500.1 | mesh | 1000 | 19 |     | SLXD |                     mesh://10.88.0.2:37277
rv_7500.2 | mesh | 1000 | 21 |     |    X |        host2_7500.1@mesh://10.88.0.3:37720
rv_7600.3 | mesh | 1000 | 24 |     | SLXD |                     mesh://10.88.0.2:37109
rv_7600.4 | mesh | 1000 | 26 |     |    X |        host2_7600.1@mesh://10.88.0.3:42620
      web |  web |      | 14 |     |    S |                            web://[::]:7580
10.88.0.2 | name |      | 17 |     |    S |  name://10.88.0.2:59432;239.23.22.217:8327</pre>
</div>
</div>
<div class="paragraph">
<p>The ANY specifier can either connect to a mesh or a TCP listener, depending
which is present.</p>
</div>
<div class="paragraph">
<p>The empty network does not attempt to connect to anything, but it will find
other services through existing connections.</p>
</div>
<div class="paragraph">
<p>If there exists a rv_7500 transport in the configuration (configured in rv.yaml
or the -cfg argument), this overrides any client specified network connection
for service 7500, so the client network argument is ignored.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_peer_names">The Peer Names</h3>
<div class="paragraph">
<p>Each <code>ms_server</code> instance uses the hostname of the machine to identify itself
unless the -user argument is used to specify another name.  The daemon port
is appended to the user name so that multiple daemons appear as hostname_7500
and hostname_7600 when -listen 7500 and -listen 7600 are used for two different
daemon instances.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="console">Console</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Console.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring">Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Monitoring.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-09-20 00:17:59 -0700
</div>
</div>
</body>
</html>